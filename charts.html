<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Analytics — fortune0</title>
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
    --bg: #0a0a0a; --card: #141414; --border: #222; --text: #e0e0e0;
    --dim: #666; --gold: #d4a843; --green: #00ffaa; --red: #ff4444;
    --blue: #4488ff; --purple: #aa44ff; --orange: #ff8844;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'SF Mono', 'Fira Code', monospace;
    background: var(--bg); color: var(--text);
    min-height: 100vh;
}
.top-bar {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 24px; border-bottom: 1px solid var(--border);
}
.top-bar a { color: var(--gold); text-decoration: none; font-size: 13px; }
.top-bar a:hover { text-decoration: underline; }
.logo { color: var(--gold); font-weight: bold; font-size: 16px; }

.container { max-width: 1100px; margin: 0 auto; padding: 24px; }

h1 { color: var(--gold); font-size: 20px; margin-bottom: 4px; }
.subtitle { color: var(--dim); font-size: 12px; margin-bottom: 24px; }

/* Stat cards */
.stats-row {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px; margin-bottom: 24px;
}
.stat-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 8px; padding: 16px; text-align: center;
}
.stat-card .number {
    font-size: 28px; font-weight: bold; color: var(--gold);
}
.stat-card .label {
    font-size: 11px; color: var(--dim); margin-top: 4px;
    text-transform: uppercase; letter-spacing: 0.5px;
}
.stat-card .delta {
    font-size: 11px; margin-top: 6px;
}
.delta.up { color: var(--green); }
.delta.down { color: var(--red); }
.delta.flat { color: var(--dim); }

/* Chart panels */
.chart-grid {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 16px; margin-bottom: 24px;
}
.chart-panel {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; padding: 20px;
}
.chart-panel.full { grid-column: 1 / -1; }
.chart-panel h3 {
    color: var(--text); font-size: 13px; margin-bottom: 12px;
    font-weight: 600;
}
.chart-panel canvas { max-height: 280px; }

/* Domain table */
.domain-table {
    width: 100%; border-collapse: collapse; font-size: 12px;
}
.domain-table th {
    text-align: left; color: var(--dim); font-size: 10px;
    text-transform: uppercase; padding: 8px 12px;
    border-bottom: 1px solid var(--border);
}
.domain-table td {
    padding: 8px 12px; border-bottom: 1px solid #1a1a1a;
}
.domain-table tr:hover { background: #1a1a1a; }
.value-bar {
    height: 4px; border-radius: 2px; background: var(--gold);
    display: inline-block; vertical-align: middle; margin-left: 8px;
}
.status-dot {
    display: inline-block; width: 8px; height: 8px; border-radius: 50%;
    margin-right: 6px;
}
.status-dot.launched { background: var(--green); }
.status-dot.open { background: var(--gold); }

.loading { text-align: center; color: var(--dim); padding: 40px; font-size: 13px; }
.error { color: var(--red); }

@media (max-width: 700px) {
    .chart-grid { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .container { padding: 16px; }
}
</style>
</head>
<body>

<div class="top-bar">
    <span class="logo">fortune0</span>
    <div>
        <a href="/app">Dashboard</a> &nbsp;
        <a href="/search">Search</a> &nbsp;
        <a href="/">Home</a>
    </div>
</div>

<div class="container">
    <h1>Platform Analytics</h1>
    <p class="subtitle">Live data from your Stripe, users, and domain portfolio</p>

    <!-- Stat cards -->
    <div class="stats-row" id="statsRow">
        <div class="loading">Loading...</div>
    </div>

    <!-- Charts -->
    <div class="chart-grid">
        <div class="chart-panel full">
            <h3>Activity Over Time</h3>
            <canvas id="activityChart"></canvas>
        </div>
        <div class="chart-panel">
            <h3>User Funnel</h3>
            <canvas id="funnelChart"></canvas>
        </div>
        <div class="chart-panel">
            <h3>Domain Value Distribution</h3>
            <canvas id="valueChart"></canvas>
        </div>
        <div class="chart-panel">
            <h3>Top 15 Domains by Value</h3>
            <canvas id="portfolioChart"></canvas>
        </div>
        <div class="chart-panel">
            <h3>Domain Categories</h3>
            <canvas id="categoryChart"></canvas>
        </div>
        <div class="chart-panel full">
            <h3>Domain Expiration Timeline</h3>
            <canvas id="expiryChart"></canvas>
        </div>
    </div>

    <!-- Domain table -->
    <div class="chart-panel full" style="margin-bottom:24px;">
        <h3>Full Domain Portfolio</h3>
        <div style="max-height:400px;overflow-y:auto;">
            <table class="domain-table" id="domainTable">
                <thead><tr><th>Domain</th><th>Value</th><th>Status</th><th>Expires</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
// ═══════════════════════════════════════════
//  Chart.js global config (dark theme)
// ═══════════════════════════════════════════
Chart.defaults.color = '#999';
Chart.defaults.borderColor = '#222';
Chart.defaults.font.family = "'SF Mono', 'Fira Code', monospace";
Chart.defaults.font.size = 11;

const GOLD = '#d4a843', GREEN = '#00ffaa', RED = '#ff4444',
      BLUE = '#4488ff', PURPLE = '#aa44ff', ORANGE = '#ff8844',
      DIM = '#444';

// ═══════════════════════════════════════════
//  LOAD ALL DATA
// ═══════════════════════════════════════════

async function init() {
    const [health, analytics, domains] = await Promise.all([
        fetch('/health').then(r => r.json()).catch(() => null),
        fetch('/api/analytics').then(r => r.json()).catch(() => null),
        fetch('/domains.json').then(r => r.json()).catch(() => []),
    ]);

    renderStats(health, analytics, domains);
    renderActivityChart(analytics);
    renderFunnelChart(health);
    renderValueChart(domains);
    renderPortfolioChart(domains);
    renderCategoryChart(domains);
    renderExpiryChart(domains);
    renderDomainTable(domains);
}

// ═══════════════════════════════════════════
//  STAT CARDS
// ═══════════════════════════════════════════

function renderStats(health, analytics, domains) {
    const h = health || {};
    const t = analytics?.totals || {};
    const totalValue = domains.reduce((s, d) => s + (d.value || 0), 0);

    const cards = [
        { number: h.users || 0, label: 'Total Users' },
        { number: h.active_users || 0, label: 'Paid ($1/mo)' },
        { number: '$' + (h.active_users || 0), label: 'Monthly Revenue' },
        { number: t.total_searches || 0, label: 'Total Searches' },
        { number: domains.length, label: 'Domains' },
        { number: totalValue.toLocaleString(), label: 'Portfolio Value' },
        { number: h.credits_from_stripe || 0, label: 'Stripe Charges' },
        { number: Math.round(h.total_credits_issued || 0), label: 'Credits Issued' },
    ];

    document.getElementById('statsRow').innerHTML = cards.map(c => `
        <div class="stat-card">
            <div class="number">${c.number}</div>
            <div class="label">${c.label}</div>
        </div>
    `).join('');
}

// ═══════════════════════════════════════════
//  ACTIVITY OVER TIME
// ═══════════════════════════════════════════

function renderActivityChart(analytics) {
    if (!analytics) return;

    // Group all activity by day
    const byDay = {};
    (analytics.activity_by_day || []).forEach(r => {
        const day = String(r.day).slice(0, 10);
        if (!byDay[day]) byDay[day] = {};
        byDay[day][r.action] = r.count;
    });

    const days = Object.keys(byDay).sort();
    if (days.length === 0) return;

    const signups = days.map(d => byDay[d]['signup'] || 0);
    const payments = days.map(d => byDay[d]['payment'] || 0);
    const searches = days.map(d => byDay[d]['search'] || 0);
    const logins = days.map(d => byDay[d]['login'] || 0);

    // Cumulative for momentum
    let cumSignups = 0, cumPayments = 0;
    const cumS = signups.map(v => cumSignups += v);
    const cumP = payments.map(v => cumPayments += v);

    new Chart(document.getElementById('activityChart'), {
        type: 'line',
        data: {
            labels: days.map(d => d.slice(5)),  // MM-DD
            datasets: [
                {
                    label: 'Signups (cumulative)',
                    data: cumS, borderColor: BLUE, backgroundColor: BLUE + '20',
                    fill: true, tension: 0.3, borderWidth: 2,
                },
                {
                    label: 'Payments (cumulative)',
                    data: cumP, borderColor: GREEN, backgroundColor: GREEN + '20',
                    fill: true, tension: 0.3, borderWidth: 2,
                },
                {
                    label: 'Searches/day',
                    data: searches, borderColor: GOLD, backgroundColor: 'transparent',
                    tension: 0.3, borderWidth: 1.5, borderDash: [4, 2],
                    yAxisID: 'y2',
                },
            ],
        },
        options: {
            responsive: true,
            interaction: { intersect: false, mode: 'index' },
            scales: {
                y: { title: { display: true, text: 'Cumulative' }, grid: { color: '#1a1a1a' } },
                y2: { position: 'right', title: { display: true, text: 'Per Day' }, grid: { display: false } },
                x: { grid: { color: '#1a1a1a' } },
            },
            plugins: { legend: { labels: { boxWidth: 12, padding: 16 } } },
        },
    });
}

// ═══════════════════════════════════════════
//  USER FUNNEL
// ═══════════════════════════════════════════

function renderFunnelChart(health) {
    if (!health) return;
    const total = health.users || 0;
    const active = health.active_users || 0;
    const free = total - active;

    new Chart(document.getElementById('funnelChart'), {
        type: 'doughnut',
        data: {
            labels: ['Paid ($1/mo)', 'Free Tier'],
            datasets: [{
                data: [active, free],
                backgroundColor: [GREEN, DIM],
                borderWidth: 0,
            }],
        },
        options: {
            responsive: true,
            cutout: '65%',
            plugins: {
                legend: { position: 'bottom', labels: { padding: 16, boxWidth: 12 } },
            },
        },
    });
}

// ═══════════════════════════════════════════
//  DOMAIN VALUE DISTRIBUTION
// ═══════════════════════════════════════════

function renderValueChart(domains) {
    const buckets = { '1000+': 0, '100-999': 0, '50-99': 0, '10-49': 0, '<10': 0 };
    domains.forEach(d => {
        const v = d.value || 0;
        if (v >= 1000) buckets['1000+']++;
        else if (v >= 100) buckets['100-999']++;
        else if (v >= 50) buckets['50-99']++;
        else if (v >= 10) buckets['10-49']++;
        else buckets['<10']++;
    });

    new Chart(document.getElementById('valueChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(buckets),
            datasets: [{
                data: Object.values(buckets),
                backgroundColor: [GOLD, BLUE, GREEN, ORANGE, PURPLE],
                borderWidth: 0, borderRadius: 4,
            }],
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { title: { display: true, text: 'Domains' }, grid: { color: '#1a1a1a' } },
                x: { grid: { display: false } },
            },
        },
    });
}

// ═══════════════════════════════════════════
//  TOP 15 DOMAINS
// ═══════════════════════════════════════════

function renderPortfolioChart(domains) {
    const top = domains.sort((a, b) => (b.value || 0) - (a.value || 0)).slice(0, 15);
    const names = top.map(d => d.domain.replace('.com', '').replace('.io', '').replace('.ai', ''));
    const values = top.map(d => d.value || 0);

    new Chart(document.getElementById('portfolioChart'), {
        type: 'bar',
        data: {
            labels: names,
            datasets: [{
                data: values,
                backgroundColor: GOLD + 'cc',
                borderWidth: 0, borderRadius: 3,
            }],
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { title: { display: true, text: 'Value Score' }, grid: { color: '#1a1a1a' } },
                y: { grid: { display: false }, ticks: { font: { size: 9 } } },
            },
        },
    });
}

// ═══════════════════════════════════════════
//  DOMAIN CATEGORIES
// ═══════════════════════════════════════════

function renderCategoryChart(domains) {
    const cats = {
        'Privacy/Data': ['death', 'data', 'privacy', 'delete', 'vault', 'proof', 'essential'],
        'Finance': ['fortune', 'dollar', 'cash', 'deal', 'ipo', 'sell', 'bootstrap', 'trillion', 'agent'],
        'Education': ['lesson', 'plan', 'learn', 'class', 'course', 'reflect', 'skill'],
        'Memes/Culture': ['meme', 'vibe', 'cringe', 'delulu', 'oof', 'yikes', 'simp'],
        'Real Estate': ['realtor', 'home', 'local', 'service', 'permit', 'contractor'],
        'Tech/Dev': ['repo', 'api', 'code', 'chrome', 'browser', 'kernel', 'template', 'tool'],
        'Creative': ['brand', 'art', 'mascot', 'tattoo', 'pfp', 'design', 'canvas'],
    };

    const counts = {};
    domains.forEach(d => {
        const name = d.domain.toLowerCase();
        let matched = false;
        for (const [cat, kws] of Object.entries(cats)) {
            if (kws.some(kw => name.includes(kw))) {
                counts[cat] = (counts[cat] || 0) + 1;
                matched = true; break;
            }
        }
        if (!matched) counts['Other'] = (counts['Other'] || 0) + 1;
    });

    const colors = [GOLD, GREEN, BLUE, ORANGE, PURPLE, RED, '#44ffaa', DIM];

    new Chart(document.getElementById('categoryChart'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(counts),
            datasets: [{
                data: Object.values(counts),
                backgroundColor: colors.slice(0, Object.keys(counts).length),
                borderWidth: 0,
            }],
        },
        options: {
            responsive: true,
            cutout: '50%',
            plugins: {
                legend: { position: 'right', labels: { padding: 8, boxWidth: 10, font: { size: 10 } } },
            },
        },
    });
}

// ═══════════════════════════════════════════
//  EXPIRATION TIMELINE
// ═══════════════════════════════════════════

function renderExpiryChart(domains) {
    const months = {};
    domains.forEach(d => {
        if (!d.expires) return;
        const m = d.expires.slice(0, 7);  // YYYY-MM
        if (!months[m]) months[m] = { count: 0, value: 0 };
        months[m].count++;
        months[m].value += d.value || 0;
    });

    const sorted = Object.keys(months).sort();
    const counts = sorted.map(m => months[m].count);
    const values = sorted.map(m => months[m].value);
    const labels = sorted.map(m => { const [y, mo] = m.split('-'); return mo + '/' + y.slice(2); });

    new Chart(document.getElementById('expiryChart'), {
        type: 'bar',
        data: {
            labels,
            datasets: [
                {
                    label: 'Domains Expiring',
                    data: counts, backgroundColor: GOLD + '99',
                    borderWidth: 0, borderRadius: 3, yAxisID: 'y',
                },
                {
                    label: 'Value at Risk',
                    data: values, type: 'line', borderColor: RED,
                    backgroundColor: 'transparent', tension: 0.3,
                    borderWidth: 2, pointRadius: 3, yAxisID: 'y2',
                },
            ],
        },
        options: {
            responsive: true,
            interaction: { intersect: false, mode: 'index' },
            scales: {
                y: { title: { display: true, text: 'Domains' }, grid: { color: '#1a1a1a' } },
                y2: { position: 'right', title: { display: true, text: 'Value' }, grid: { display: false } },
                x: { grid: { display: false } },
            },
            plugins: { legend: { labels: { boxWidth: 12, padding: 16 } } },
        },
    });
}

// ═══════════════════════════════════════════
//  DOMAIN TABLE
// ═══════════════════════════════════════════

function renderDomainTable(domains) {
    const sorted = [...domains].sort((a, b) => (b.value || 0) - (a.value || 0));
    const maxVal = sorted[0]?.value || 1;
    const tbody = document.querySelector('#domainTable tbody');

    tbody.innerHTML = sorted.map(d => `
        <tr>
            <td><a href="https://${d.domain}" target="_blank" style="color:var(--gold);text-decoration:none;">${d.domain}</a></td>
            <td>
                ${d.value || 0}
                <span class="value-bar" style="width:${Math.max(2, (d.value || 0) / maxVal * 80)}px;"></span>
            </td>
            <td><span class="status-dot ${d.status || 'open'}"></span>${d.status || 'open'}</td>
            <td style="color:var(--dim);">${d.expires || '?'}</td>
        </tr>
    `).join('');
}

// ═══════════════════════════════════════════
init();
</script>
</body>
</html>
