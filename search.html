<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>death2data — private search</title>
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<style>
:root {
    --bg:#0A0A0A;--surface:#111;--surface2:#1A1A1A;
    --border:#222;--border-l:#333;
    --accent:#50C878;--accent-dim:rgba(80,200,120,0.15);
    --white:#F0F0F0;--text:rgba(255,255,255,0.55);--dim:rgba(255,255,255,0.25);
    --red:#EF476F;--gold:#D4AF37;
    --font:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',sans-serif;
    --mono:'SF Mono','Menlo','Consolas',monospace;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{-webkit-font-smoothing:antialiased;}
body{background:var(--bg);color:var(--text);font-family:var(--font);font-size:14px;line-height:1.6;min-height:100vh;}
::selection{background:rgba(80,200,120,0.2);}
a{color:var(--accent);text-decoration:none;}
a:hover{opacity:0.8;}

.wrap{
    display:flex;flex-direction:column;align-items:center;
    min-height:100vh;padding:20px;transition:all 0.4s;
    justify-content:center;
}
.wrap.has-results{justify-content:flex-start;padding-top:40px;}

.logo{
    font-family:var(--mono);font-size:28px;font-weight:800;
    color:var(--white);letter-spacing:-1px;margin-bottom:4px;
    transition:all 0.3s;cursor:pointer;
}
.wrap.has-results .logo{font-size:18px;}
.tagline{font-size:13px;color:var(--dim);margin-bottom:24px;transition:all 0.3s;}
.wrap.has-results .tagline{font-size:11px;margin-bottom:12px;}

/* Auth bar */
.auth-bar{
    width:100%;max-width:600px;margin-bottom:12px;
    display:flex;align-items:center;gap:8px;
}
.auth-bar input{
    flex:1;background:var(--surface);border:1px solid var(--border);
    color:var(--white);padding:8px 12px;border-radius:8px;font-size:13px;
    font-family:var(--font);outline:none;
}
.auth-bar input:focus{border-color:var(--accent);}
.auth-bar input::placeholder{color:var(--dim);}
.auth-bar button{
    background:none;border:1px solid var(--border);color:var(--text);
    padding:8px 14px;border-radius:8px;font-size:12px;cursor:pointer;
    white-space:nowrap;font-family:var(--font);
}
.auth-bar button:hover{border-color:var(--accent);color:var(--accent);}
.user-badge{
    font-family:var(--mono);font-size:12px;color:var(--accent);
    display:flex;align-items:center;gap:6px;flex:1;
}
.user-badge .dot{width:6px;height:6px;border-radius:50%;background:var(--accent);}

/* Status badge */
.status-line{
    font-family:var(--mono);font-size:11px;margin-bottom:8px;
}
.status-active{color:var(--accent);}
.status-locked{color:var(--red);}
.status-free{color:var(--dim);}

/* Search bar */
.search-box{width:100%;max-width:600px;position:relative;margin-bottom:20px;}
.search-input{
    width:100%;background:var(--surface);border:1px solid var(--border);
    color:var(--white);padding:14px 48px 14px 18px;border-radius:12px;
    font-size:16px;font-family:var(--font);outline:none;transition:border-color 0.2s;
}
.search-input:focus{border-color:var(--accent);}
.search-input::placeholder{color:var(--dim);}
.search-btn{
    position:absolute;right:6px;top:50%;transform:translateY(-50%);
    background:var(--accent);border:none;color:#000;
    width:36px;height:36px;border-radius:8px;cursor:pointer;
    display:flex;align-items:center;justify-content:center;transition:all 0.2s;
}
.search-btn:hover{box-shadow:0 0 20px rgba(80,200,120,0.3);}

/* Loading */
.loading{display:none;width:100%;max-width:600px;text-align:center;padding:40px 0;color:var(--dim);font-family:var(--mono);font-size:13px;}
.loading.show{display:block;}

/* Results */
.results{width:100%;max-width:600px;}
.result{
    background:var(--surface);border:1px solid var(--border);border-radius:10px;
    padding:16px;margin-bottom:8px;transition:all 0.15s;
}
.result:hover{border-color:var(--border-l);background:var(--surface2);}
.result a{display:block;}
.result-url{font-family:var(--mono);font-size:11px;color:var(--accent);margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.result-title{color:var(--white);font-weight:600;font-size:15px;margin-bottom:6px;}
.result-snippet{font-size:13px;color:var(--text);line-height:1.5;}
.result-snippet mark{background:var(--accent-dim);color:var(--accent);padding:0 2px;border-radius:2px;}

/* No results */
.no-results{text-align:center;padding:40px 0;color:var(--dim);}

/* Gate (paywall) */
.gate{
    display:none;width:100%;max-width:600px;
    background:var(--surface);border:1px solid rgba(80,200,120,0.2);
    border-radius:14px;padding:28px;text-align:center;margin-top:8px;
}
.gate.show{display:block;}
.gate h2{color:var(--white);font-size:20px;margin-bottom:8px;}
.gate p{color:var(--text);font-size:14px;margin-bottom:20px;line-height:1.6;}
.gate-grid{
    display:grid;grid-template-columns:1fr 1fr;gap:8px;
    margin-bottom:24px;text-align:left;
}
.gate-item{
    background:var(--bg);border:1px solid var(--border);border-radius:8px;
    padding:10px 12px;
}
.gate-item-label{color:var(--white);font-weight:500;font-size:12px;margin-bottom:2px;}
.gate-item-desc{color:var(--dim);font-size:11px;}
.gate-btn{
    display:inline-block;background:var(--accent);color:#000;
    padding:12px 32px;border-radius:10px;font-size:15px;font-weight:700;
    border:none;cursor:pointer;transition:all 0.2s;text-decoration:none;
}
.gate-btn:hover{box-shadow:0 0 30px rgba(80,200,120,0.4);transform:scale(1.02);color:#000;}
.gate-sub{display:block;margin-top:12px;font-size:12px;color:var(--dim);}

/* Verify bar */
.verify-bar{
    display:none;width:100%;max-width:600px;
    background:var(--surface);border:1px solid var(--border);
    border-radius:10px;padding:14px 16px;margin-top:8px;
    text-align:center;
}
.verify-bar.show{display:block;}
.verify-bar p{color:var(--text);font-size:13px;margin-bottom:10px;}
.verify-btn{
    background:none;border:1px solid var(--accent);color:var(--accent);
    padding:8px 20px;border-radius:8px;font-size:13px;cursor:pointer;
    font-family:var(--font);transition:all 0.2s;
}
.verify-btn:hover{background:var(--accent);color:#000;}

/* Footer */
.foot{
    position:fixed;bottom:0;left:0;right:0;
    padding:12px 20px;display:flex;justify-content:center;gap:20px;
    font-size:11px;color:var(--dim);background:linear-gradient(transparent,var(--bg));
}
.foot a{color:var(--dim);}
.foot a:hover{color:var(--accent);}

@media(max-width:600px){
    .logo{font-size:22px;}
    .search-input{font-size:14px;padding:12px 44px 12px 14px;}
    .gate-grid{grid-template-columns:1fr;}
    .gate{padding:20px;}
    .result{padding:12px;}
}
</style>
</head>
<body>

<div class="wrap" id="wrap">
    <div class="logo" onclick="location.href='/search'">death2data</div>
    <div class="tagline">search without surveillance</div>

    <div class="auth-bar" id="auth-bar">
        <input type="email" id="auth-email" placeholder="sign in with your email" onkeydown="if(event.key==='Enter')signIn()">
        <button onclick="signIn()">Sign in</button>
    </div>

    <div class="status-line" id="status"></div>

    <div class="search-box">
        <input type="text" class="search-input" id="q" placeholder="search anything..." autocomplete="off" onkeydown="if(event.key==='Enter')doSearch()">
        <button class="search-btn" onclick="doSearch()">
            <svg width="18" height="18" viewBox="0 0 16 16" fill="none"><circle cx="6.5" cy="6.5" r="5" stroke="currentColor" stroke-width="2"/><path d="M10 10l4.5 4.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
    </div>

    <div class="loading" id="loading">searching...</div>
    <div class="results" id="results"></div>

    <!-- Paywall gate -->
    <div class="gate" id="gate">
        <h2 id="gate-title">Private search. $1/month.</h2>
        <p id="gate-desc">Death2data doesn't track you, sell your data, or build a profile on you. That's the product. Your $1 keeps it running.</p>
        <div class="gate-grid">
            <div class="gate-item"><div class="gate-item-label">No tracking</div><div class="gate-item-desc">Zero cookies, fingerprints, or profiles</div></div>
            <div class="gate-item"><div class="gate-item-label">Unlimited search</div><div class="gate-item-desc">No caps or throttling</div></div>
            <div class="gate-item"><div class="gate-item-label">Local-first tools</div><div class="gate-item-desc">Your data stays on your machine</div></div>
            <div class="gate-item"><div class="gate-item-label">Credits</div><div class="gate-item-desc">Earn across the fortune0 network</div></div>
        </div>
        <a class="gate-btn" id="gate-btn" href="/onboard?from=d2d">Get access — $1/mo</a>
        <span class="gate-sub">cancel anytime. no contracts.</span>
    </div>

    <!-- Verify payment for users who already paid but show as free -->
    <div class="verify-bar" id="verify-bar">
        <p>Already paid? Payment verification can take a moment.</p>
        <button class="verify-btn" onclick="verifyPayment()">Check my payment status</button>
    </div>
</div>

<div class="foot">
    <span>no tracking. no ads. no profile.</span>
    <a href="/app">dashboard</a>
    <a href="/">fortune0</a>
</div>

<script>
const S = { user: null, token: null, tier: null, ref: '' };

// Grab ref from URL
const params = new URLSearchParams(location.search);
S.ref = params.get('ref') || '';

// ═══ INIT ═══
(async function init() {
    // Restore session
    const saved = sessionStorage.getItem('f0_token');
    const savedEmail = sessionStorage.getItem('f0_email');
    if (saved && savedEmail) {
        S.token = saved;
        S.user = { email: savedEmail };
        showAuthed();
        // Verify tier from server
        await checkTier();
    } else {
        // Not signed in — show the gate immediately
        updateStatus();
        showGate('sign-in');
    }
    document.getElementById('q').focus();
})();

// ═══ AUTH ═══
async function signIn() {
    const email = document.getElementById('auth-email').value.trim().toLowerCase();
    if (!email) return;
    try {
        const body = { email };
        if (S.ref) body.referred_by = S.ref;
        const resp = await fetch('/api/signup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        const data = await resp.json();
        if (data.token) {
            S.user = { email: data.email, code: data.referral_code };
            S.token = data.token;
            S.tier = data.tier;
            sessionStorage.setItem('f0_token', data.token);
            sessionStorage.setItem('f0_email', data.email);
            showAuthed();

            if (S.tier === 'active') {
                // Paid user — unlock search
                document.getElementById('gate').classList.remove('show');
                document.getElementById('verify-bar').classList.remove('show');
                updateStatus();
            } else {
                // Free tier — show activation gate
                showGate('activate');
            }
        }
    } catch (e) {
        console.error('Sign in error:', e);
    }
}

async function checkTier() {
    try {
        const resp = await fetch('/api/me', {
            headers: { 'Authorization': 'Bearer ' + S.token },
        });
        if (resp.ok) {
            const data = await resp.json();
            S.tier = data.tier;
            S.user.code = data.referral_code;
            if (S.tier === 'active') {
                document.getElementById('gate').classList.remove('show');
                document.getElementById('verify-bar').classList.remove('show');
            } else {
                showGate('activate');
            }
        } else {
            // Token expired
            signOut();
            showGate('sign-in');
        }
    } catch (e) {
        // Offline — assume they're good if they have a token
        S.tier = 'active';
    }
    updateStatus();
}

function showAuthed() {
    const bar = document.getElementById('auth-bar');
    bar.innerHTML = `
        <div class="user-badge"><div class="dot"></div> ${S.user.email}</div>
        <button onclick="signOut()">Sign out</button>
    `;
}

function signOut() {
    S.user = null; S.token = null; S.tier = null;
    sessionStorage.removeItem('f0_token');
    sessionStorage.removeItem('f0_email');
    document.getElementById('auth-bar').innerHTML = `
        <input type="email" id="auth-email" placeholder="sign in with your email" onkeydown="if(event.key==='Enter')signIn()">
        <button onclick="signIn()">Sign in</button>
    `;
    document.getElementById('results').innerHTML = '';
    document.getElementById('wrap').classList.remove('has-results');
    document.getElementById('verify-bar').classList.remove('show');
    updateStatus();
    showGate('sign-in');
}

// ═══ SEARCH ═══
async function doSearch() {
    const q = document.getElementById('q').value.trim();
    if (!q) return;

    // Client-side gate: must be signed in + active tier
    if (!S.user || !S.token) {
        showGate('sign-in');
        return;
    }
    if (S.tier !== 'active') {
        showGate('activate');
        return;
    }

    document.getElementById('wrap').classList.add('has-results');
    document.getElementById('loading').classList.add('show');
    document.getElementById('results').innerHTML = '';
    document.getElementById('gate').classList.remove('show');

    try {
        const resp = await fetch(`/api/search?q=${encodeURIComponent(q)}`, {
            headers: { 'Authorization': 'Bearer ' + S.token },
        });
        const data = await resp.json();
        document.getElementById('loading').classList.remove('show');

        if (resp.status === 401) {
            // Token expired
            signOut();
            showGate('sign-in');
            return;
        }
        if (resp.status === 403) {
            // Not active tier — server rejected
            S.tier = data.tier || 'free';
            showGate('activate');
            return;
        }

        if (data.results && data.results.length > 0) {
            renderResults(data.results, q);
        } else {
            document.getElementById('results').innerHTML = '<div class="no-results">No results found. Try a different search.</div>';
        }
    } catch (e) {
        document.getElementById('loading').classList.remove('show');
        document.getElementById('results').innerHTML = '<div class="no-results">Search unavailable. Try again in a moment.</div>';
    }
}

function renderResults(results, q) {
    const el = document.getElementById('results');
    const words = q.toLowerCase().split(/\s+/).filter(w => w.length > 2);

    el.innerHTML = results.map(r => {
        let snippet = esc(r.snippet || '');
        words.forEach(w => {
            const re = new RegExp(`(${w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            snippet = snippet.replace(re, '<mark>$1</mark>');
        });
        return `<div class="result">
            <a href="${esc(r.url)}" target="_blank" rel="noopener">
                <div class="result-url">${esc(r.url)}</div>
                <div class="result-title">${esc(r.title)}</div>
            </a>
            <div class="result-snippet">${snippet}</div>
        </div>`;
    }).join('');
}

// ═══ GATE ═══
function showGate(mode) {
    const gate = document.getElementById('gate');
    const title = document.getElementById('gate-title');
    const desc = document.getElementById('gate-desc');
    const btn = document.getElementById('gate-btn');
    const verify = document.getElementById('verify-bar');

    let url = '/onboard?from=d2d';
    if (S.ref) url += '&ref=' + S.ref;
    if (S.user && S.user.code) url += '&ref=' + S.user.code;

    if (mode === 'sign-in') {
        title.textContent = 'Private search. $1/month.';
        desc.textContent = "Death2data doesn't track you, sell your data, or build a profile on you. That's the product. Sign in or create an account to get started.";
        btn.href = url;
        btn.textContent = 'Get access — $1/mo';
        verify.classList.remove('show');
    } else if (mode === 'activate') {
        title.textContent = 'Activate your account';
        desc.textContent = "You're signed in but your account isn't active yet. Activate for $1/month to unlock unlimited private search.";
        btn.href = url;
        btn.textContent = 'Activate — $1/mo';
        verify.classList.add('show');
    }

    gate.classList.add('show');
    updateStatus();
}

// ═══ VERIFY PAYMENT ═══
async function verifyPayment() {
    if (!S.token) return;
    const btn = document.querySelector('.verify-btn');
    btn.textContent = 'Checking...';
    btn.disabled = true;

    try {
        const resp = await fetch('/api/me', {
            headers: { 'Authorization': 'Bearer ' + S.token },
        });
        if (resp.ok) {
            const data = await resp.json();
            S.tier = data.tier;
            if (S.tier === 'active') {
                document.getElementById('gate').classList.remove('show');
                document.getElementById('verify-bar').classList.remove('show');
                updateStatus();
                // Auto-search if they had something typed
                const q = document.getElementById('q').value.trim();
                if (q) doSearch();
                return;
            }
        }
    } catch (e) {}

    btn.textContent = 'Not yet — try again in a moment';
    btn.disabled = false;
    setTimeout(() => { btn.textContent = 'Check my payment status'; }, 3000);
}

// ═══ HELPERS ═══
function updateStatus() {
    const el = document.getElementById('status');
    if (!S.user) {
        el.textContent = 'sign in to search';
        el.className = 'status-line status-locked';
    } else if (S.tier === 'active') {
        el.textContent = 'unlimited private search';
        el.className = 'status-line status-active';
    } else {
        el.textContent = 'account inactive — activate to search';
        el.className = 'status-line status-free';
    }
}

function esc(s) {
    if (!s) return '';
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}
</script>
</body>
</html>
