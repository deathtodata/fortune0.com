<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>death2data — private search</title>
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<style>
:root {
    --bg:#0A0A0A;--surface:#111;--surface2:#1A1A1A;
    --border:#222;--border-l:#333;
    --accent:#50C878;--accent-dim:rgba(80,200,120,0.15);
    --white:#F0F0F0;--text:rgba(255,255,255,0.55);--dim:rgba(255,255,255,0.25);
    --red:#EF476F;--gold:#D4AF37;
    --font:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',sans-serif;
    --mono:'SF Mono','Menlo','Consolas',monospace;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{-webkit-font-smoothing:antialiased;}
body{background:var(--bg);color:var(--text);font-family:var(--font);font-size:14px;line-height:1.6;min-height:100vh;}
::selection{background:rgba(80,200,120,0.2);}
a{color:var(--accent);text-decoration:none;}
a:hover{opacity:0.8;}

.wrap{
    display:flex;flex-direction:column;align-items:center;
    min-height:100vh;padding:20px;transition:all 0.4s;
    justify-content:center;
}
.wrap.has-results{justify-content:flex-start;padding-top:40px;}

.logo{
    font-family:var(--mono);font-size:28px;font-weight:800;
    color:var(--white);letter-spacing:-1px;margin-bottom:4px;
    transition:all 0.3s;cursor:pointer;
}
.wrap.has-results .logo{font-size:18px;}
.tagline{font-size:13px;color:var(--dim);margin-bottom:24px;transition:all 0.3s;}
.wrap.has-results .tagline{font-size:11px;margin-bottom:12px;}

/* Auth bar */
.auth-bar{
    width:100%;max-width:600px;margin-bottom:12px;
    display:flex;align-items:center;gap:8px;
}
.auth-bar input{
    flex:1;background:var(--surface);border:1px solid var(--border);
    color:var(--white);padding:8px 12px;border-radius:8px;font-size:13px;
    font-family:var(--font);outline:none;
}
.auth-bar input:focus{border-color:var(--accent);}
.auth-bar input::placeholder{color:var(--dim);}
.auth-bar button{
    background:none;border:1px solid var(--border);color:var(--text);
    padding:8px 14px;border-radius:8px;font-size:12px;cursor:pointer;
    white-space:nowrap;font-family:var(--font);
}
.auth-bar button:hover{border-color:var(--accent);color:var(--accent);}
.user-badge{
    font-family:var(--mono);font-size:12px;color:var(--accent);
    display:flex;align-items:center;gap:6px;flex:1;
}
.user-badge .dot{width:6px;height:6px;border-radius:50%;background:var(--accent);}

/* Counter */
.counter{font-family:var(--mono);font-size:11px;color:var(--dim);margin-bottom:8px;}

/* Search bar */
.search-box{width:100%;max-width:600px;position:relative;margin-bottom:20px;}
.search-input{
    width:100%;background:var(--surface);border:1px solid var(--border);
    color:var(--white);padding:14px 48px 14px 18px;border-radius:12px;
    font-size:16px;font-family:var(--font);outline:none;transition:border-color 0.2s;
}
.search-input:focus{border-color:var(--accent);}
.search-input::placeholder{color:var(--dim);}
.search-btn{
    position:absolute;right:6px;top:50%;transform:translateY(-50%);
    background:var(--accent);border:none;color:#000;
    width:36px;height:36px;border-radius:8px;cursor:pointer;
    display:flex;align-items:center;justify-content:center;transition:all 0.2s;
}
.search-btn:hover{box-shadow:0 0 20px rgba(80,200,120,0.3);}

/* Loading */
.loading{display:none;width:100%;max-width:600px;text-align:center;padding:40px 0;color:var(--dim);font-family:var(--mono);font-size:13px;}
.loading.show{display:block;}

/* Results */
.results{width:100%;max-width:600px;}
.result{
    background:var(--surface);border:1px solid var(--border);border-radius:10px;
    padding:16px;margin-bottom:8px;transition:all 0.15s;
}
.result:hover{border-color:var(--border-l);background:var(--surface2);}
.result a{display:block;}
.result-url{font-family:var(--mono);font-size:11px;color:var(--accent);margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.result-title{color:var(--white);font-weight:600;font-size:15px;margin-bottom:6px;}
.result-snippet{font-size:13px;color:var(--text);line-height:1.5;}
.result-snippet mark{background:var(--accent-dim);color:var(--accent);padding:0 2px;border-radius:2px;}

/* Locked results */
.result.locked{position:relative;pointer-events:none;}
.result.locked .result-title,
.result.locked .result-snippet{filter:blur(6px);user-select:none;}
.result.locked .result-url{filter:blur(4px);user-select:none;}

/* No results */
.no-results{text-align:center;padding:40px 0;color:var(--dim);}

/* Gate */
.gate{
    display:none;width:100%;max-width:600px;
    background:var(--surface);border:1px solid rgba(80,200,120,0.2);
    border-radius:14px;padding:28px;text-align:center;margin-top:8px;
}
.gate.show{display:block;}
.gate h2{color:var(--white);font-size:20px;margin-bottom:8px;}
.gate p{color:var(--text);font-size:14px;margin-bottom:20px;line-height:1.6;}
.gate-grid{
    display:grid;grid-template-columns:1fr 1fr;gap:8px;
    margin-bottom:24px;text-align:left;
}
.gate-item{
    background:var(--bg);border:1px solid var(--border);border-radius:8px;
    padding:10px 12px;
}
.gate-item-label{color:var(--white);font-weight:500;font-size:12px;margin-bottom:2px;}
.gate-item-desc{color:var(--dim);font-size:11px;}
.gate-btn{
    display:inline-block;background:var(--accent);color:#000;
    padding:12px 32px;border-radius:10px;font-size:15px;font-weight:700;
    border:none;cursor:pointer;transition:all 0.2s;text-decoration:none;
}
.gate-btn:hover{box-shadow:0 0 30px rgba(80,200,120,0.4);transform:scale(1.02);color:#000;}
.gate-skip{display:block;margin-top:12px;font-size:12px;color:var(--dim);cursor:pointer;}
.gate-skip:hover{color:var(--text);}

/* Footer */
.foot{
    position:fixed;bottom:0;left:0;right:0;
    padding:12px 20px;display:flex;justify-content:center;gap:20px;
    font-size:11px;color:var(--dim);background:linear-gradient(transparent,var(--bg));
}
.foot a{color:var(--dim);}
.foot a:hover{color:var(--accent);}

@media(max-width:600px){
    .logo{font-size:22px;}
    .search-input{font-size:14px;padding:12px 44px 12px 14px;}
    .gate-grid{grid-template-columns:1fr;}
    .gate{padding:20px;}
    .result{padding:12px;}
}
</style>
</head>
<body>

<div class="wrap" id="wrap">
    <div class="logo" onclick="location.href='/search'">death2data</div>
    <div class="tagline">search without surveillance</div>

    <div class="auth-bar" id="auth-bar">
        <input type="email" id="auth-email" placeholder="have an account? sign in" onkeydown="if(event.key==='Enter')signIn()">
        <button onclick="signIn()">Sign in</button>
    </div>

    <div class="counter" id="counter"></div>

    <div class="search-box">
        <input type="text" class="search-input" id="q" placeholder="search anything..." autocomplete="off" onkeydown="if(event.key==='Enter')doSearch()">
        <button class="search-btn" onclick="doSearch()">
            <svg width="18" height="18" viewBox="0 0 16 16" fill="none"><circle cx="6.5" cy="6.5" r="5" stroke="currentColor" stroke-width="2"/><path d="M10 10l4.5 4.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
    </div>

    <div class="loading" id="loading">searching...</div>
    <div class="results" id="results"></div>
    <div class="gate" id="gate">
        <h2>You've used your free searches</h2>
        <p>Death2data doesn't track you, sell your data, or build a profile. That's the product. $1/month keeps it that way.</p>
        <div class="gate-grid">
            <div class="gate-item"><div class="gate-item-label">No tracking</div><div class="gate-item-desc">Zero cookies, fingerprints, or profiles</div></div>
            <div class="gate-item"><div class="gate-item-label">Unlimited search</div><div class="gate-item-desc">No caps or throttling</div></div>
            <div class="gate-item"><div class="gate-item-label">Local-first tools</div><div class="gate-item-desc">Your data stays on your machine</div></div>
            <div class="gate-item"><div class="gate-item-label">Credits</div><div class="gate-item-desc">Earn across the fortune0 network</div></div>
        </div>
        <a class="gate-btn" id="gate-btn" href="/onboard?from=d2d">Get access — $1/mo</a>
        <span class="gate-skip" onclick="dismissGate()">maybe later</span>
    </div>
</div>

<div class="foot">
    <span>no tracking. no ads. no profile.</span>
    <a href="/app">dashboard</a>
    <a href="/">fortune0</a>
</div>

<script>
const S = { searches: 0, maxFree: 3, user: null, token: null, ref: '' };

// Grab ref from URL
const params = new URLSearchParams(location.search);
S.ref = params.get('ref') || '';

// Restore session
const saved = sessionStorage.getItem('f0_token');
const savedEmail = sessionStorage.getItem('f0_email');
if (saved && savedEmail) {
    S.token = saved;
    S.user = { email: savedEmail };
    S.maxFree = Infinity;
    showAuthed();
}
updateCounter();
document.getElementById('q').focus();

// ═══ AUTH ═══
async function signIn() {
    const email = document.getElementById('auth-email').value.trim().toLowerCase();
    if (!email) return;
    try {
        const body = { email };
        if (S.ref) body.referred_by = S.ref;
        const resp = await fetch('/api/signup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        const data = await resp.json();
        if (data.token) {
            S.user = { email: data.email, code: data.referral_code, tier: data.tier };
            S.token = data.token;
            S.maxFree = Infinity;
            sessionStorage.setItem('f0_token', data.token);
            sessionStorage.setItem('f0_email', data.email);
            showAuthed();
            document.getElementById('gate').classList.remove('show');
            updateCounter();
        }
    } catch (e) {
        S.maxFree = Infinity; // Offline fallback
    }
}

function showAuthed() {
    const bar = document.getElementById('auth-bar');
    bar.innerHTML = `
        <div class="user-badge"><div class="dot"></div> ${S.user.email}</div>
        <button onclick="signOut()">Sign out</button>
    `;
}

function signOut() {
    S.user = null; S.token = null; S.maxFree = 3; S.searches = 0;
    sessionStorage.removeItem('f0_token');
    sessionStorage.removeItem('f0_email');
    document.getElementById('auth-bar').innerHTML = `
        <input type="email" id="auth-email" placeholder="have an account? sign in" onkeydown="if(event.key==='Enter')signIn()">
        <button onclick="signIn()">Sign in</button>
    `;
    document.getElementById('results').innerHTML = '';
    document.getElementById('gate').classList.remove('show');
    document.getElementById('wrap').classList.remove('has-results');
    updateCounter();
}

// ═══ SEARCH ═══
async function doSearch() {
    const q = document.getElementById('q').value.trim();
    if (!q) return;

    if (S.searches >= S.maxFree && !S.user) {
        showGate();
        return;
    }

    S.searches++;
    updateCounter();
    document.getElementById('wrap').classList.add('has-results');
    document.getElementById('loading').classList.add('show');
    document.getElementById('results').innerHTML = '';

    try {
        const headers = {};
        if (S.token) headers['Authorization'] = 'Bearer ' + S.token;
        const resp = await fetch(`/api/search?q=${encodeURIComponent(q)}`, { headers });
        const data = await resp.json();
        document.getElementById('loading').classList.remove('show');

        if (data.results && data.results.length > 0) {
            renderResults(data.results, q);
        } else {
            document.getElementById('results').innerHTML = '<div class="no-results">No results found. Try a different search.</div>';
        }
    } catch (e) {
        document.getElementById('loading').classList.remove('show');
        document.getElementById('results').innerHTML = '<div class="no-results">Search unavailable. Try again in a moment.</div>';
    }

    if (S.searches >= S.maxFree && !S.user) {
        setTimeout(() => showGate(), 800);
    }
}

function renderResults(results, q) {
    const el = document.getElementById('results');
    const words = q.toLowerCase().split(/\s+/).filter(w => w.length > 2);
    const atLimit = S.searches >= S.maxFree && !S.user;

    el.innerHTML = results.map((r, i) => {
        const locked = atLimit && i >= 3;
        let snippet = esc(r.snippet || '');
        words.forEach(w => {
            const re = new RegExp(`(${w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            snippet = snippet.replace(re, '<mark>$1</mark>');
        });
        return `<div class="result ${locked ? 'locked' : ''}">
            <a href="${locked ? '#' : esc(r.url)}" ${locked ? '' : 'target="_blank" rel="noopener"'}>
                <div class="result-url">${esc(r.url)}</div>
                <div class="result-title">${esc(r.title)}</div>
            </a>
            <div class="result-snippet">${snippet}</div>
        </div>`;
    }).join('');
}

// ═══ GATE ═══
function showGate() {
    const gate = document.getElementById('gate');
    gate.classList.add('show');
    let url = '/onboard?from=d2d';
    if (S.ref) url += '&ref=' + S.ref;
    document.getElementById('gate-btn').href = url;
}

function dismissGate() {
    document.getElementById('gate').classList.remove('show');
    S.maxFree = S.searches + 1;
    updateCounter();
}

// ═══ HELPERS ═══
function updateCounter() {
    const el = document.getElementById('counter');
    if (S.user) {
        el.textContent = 'unlimited searches';
        el.style.color = 'var(--accent)';
    } else if (S.searches === 0) {
        el.textContent = S.maxFree + ' free searches';
    } else {
        const r = Math.max(0, S.maxFree - S.searches);
        el.textContent = r > 0 ? r + ' free search' + (r === 1 ? '' : 'es') + ' remaining' : 'free searches used';
        el.style.color = r <= 1 ? 'var(--red)' : '';
    }
}

function esc(s) {
    if (!s) return '';
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}
</script>
</body>
</html>
