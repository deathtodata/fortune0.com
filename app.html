<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>fortune0 — Platform Console</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<style>
:root {
    --bg:#000000;--surface:#0A0A0A;--surface2:#141414;--surface3:#1E1E1E;
    --border:#1A1A1A;--border-l:#2A2A2A;
    --gold:#D4AF37;--gold-rgb:212,175,55;
    --red:#EF476F;--purple:#B388FF;--orange:#FF8C42;--yellow:#D4AF37;
    --white:#FFFFFF;--text:rgba(255,255,255,0.6);--dim:rgba(255,255,255,0.3);
    --font:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',sans-serif;
    --mono:'SF Mono','Menlo',monospace;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;-webkit-font-smoothing:antialiased;}
body{background:var(--bg);color:var(--text);font-family:var(--font);font-size:14px;line-height:1.6;display:flex;flex-direction:column;min-height:100vh;}
a{color:var(--gold);text-decoration:none;}
a:hover{opacity:0.8;}
::selection{background:rgba(212,175,55,0.2);}
button{font-family:var(--font);cursor:pointer;}
input,select,textarea{font-family:var(--font);}

/* ═══ HEADER ═══ */
header{
    position:sticky;top:0;z-index:100;
    background:rgba(0,0,0,0.92);backdrop-filter:blur(20px);
    border-bottom:1px solid var(--border);
}
.header-main{
    display:flex;align-items:center;justify-content:space-between;
    max-width:1200px;margin:0 auto;padding:0 20px;height:56px;
}
.logo{display:flex;align-items:center;gap:8px;font-family:var(--mono);font-weight:700;font-size:16px;color:var(--white);cursor:pointer;}
.logo svg{width:24px;height:24px;}
.nav-center{display:flex;gap:4px;}
.nav-btn{
    background:none;border:1px solid transparent;color:var(--dim);
    padding:6px 14px;border-radius:8px;font-size:13px;font-weight:500;
    transition:all 0.15s;
}
.nav-btn:hover{color:var(--text);background:var(--surface);}
.nav-btn.active{color:var(--gold);background:rgba(212,175,55,0.06);border-color:rgba(212,175,55,0.15);}
.nav-right{display:flex;align-items:center;gap:12px;}
.auth-state{display:flex;align-items:center;gap:8px;font-size:12px;font-family:var(--mono);}
.auth-dot{width:8px;height:8px;border-radius:50%;}
.auth-dot.on{background:var(--gold);box-shadow:0 0 8px rgba(212,175,55,0.4);}
.auth-dot.off{background:var(--red);box-shadow:0 0 8px rgba(239,71,111,0.3);}
.ssl-badge{
    display:flex;align-items:center;gap:4px;
    font-size:11px;color:var(--dim);background:var(--surface);
    padding:3px 8px;border-radius:4px;border:1px solid var(--border);
}
.ssl-badge svg{width:12px;height:12px;color:var(--gold);}

/* ═══ BREADCRUMB ═══ */
.breadcrumb{
    max-width:1200px;margin:0 auto;padding:8px 20px;
    font-size:12px;font-family:var(--mono);color:var(--dim);
    border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px;
}
.breadcrumb a{color:var(--dim);}
.breadcrumb a:hover{color:var(--gold);}
.breadcrumb .sep{opacity:0.3;}

/* ═══ MAIN LAYOUT ═══ */
.main{flex:1;display:flex;max-width:1200px;margin:0 auto;width:100%;}
.content{flex:1;padding:24px 20px;min-width:0;}

/* ═══ CONSOLE PANEL ═══ */
.console-toggle{
    position:fixed;bottom:20px;right:20px;z-index:50;
    background:var(--surface2);border:1px solid var(--border);
    color:var(--gold);padding:10px 16px;border-radius:10px;
    font-family:var(--mono);font-size:12px;font-weight:600;
    display:flex;align-items:center;gap:8px;
    box-shadow:0 4px 20px rgba(0,0,0,0.4);
}
.console-toggle .count{
    background:var(--gold);color:var(--bg);
    padding:1px 6px;border-radius:99px;font-size:10px;min-width:18px;text-align:center;
}
.console{
    position:fixed;bottom:0;left:0;right:0;z-index:90;
    background:var(--bg);border-top:2px solid var(--gold);
    transition:transform 0.3s;transform:translateY(100%);
    max-height:45vh;display:flex;flex-direction:column;
}
.console.open{transform:translateY(0);}
.console-header{
    display:flex;align-items:center;justify-content:space-between;
    padding:8px 16px;background:var(--surface);border-bottom:1px solid var(--border);
    flex-shrink:0;
}
.console-header h4{font-family:var(--mono);font-size:12px;color:var(--gold);display:flex;align-items:center;gap:8px;}
.console-actions{display:flex;gap:8px;}
.console-btn{
    background:var(--surface2);border:1px solid var(--border);color:var(--text);
    padding:4px 10px;border-radius:6px;font-size:11px;font-family:var(--mono);
}
.console-btn:hover{border-color:var(--dim);}
.console-btn.danger{color:var(--red);}
.console-body{overflow-y:auto;flex:1;padding:8px 0;font-family:var(--mono);font-size:12px;}
.log-entry{
    display:flex;gap:12px;padding:4px 16px;
    border-bottom:1px solid rgba(30,30,54,0.5);
    transition:background 0.15s;
}
.log-entry:hover{background:var(--surface);}
.log-time{color:var(--dim);min-width:80px;flex-shrink:0;}
.log-method{min-width:48px;font-weight:600;flex-shrink:0;}
.log-method.GET{color:var(--gold);}
.log-method.POST{color:var(--gold);}
.log-method.ERR{color:var(--red);}
.log-method.SYS{color:var(--gold);}
.log-method.SEC{color:var(--purple);}
.log-method.TEST{color:var(--orange);}
.log-path{color:var(--text);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.log-status{min-width:32px;text-align:right;flex-shrink:0;}
.log-status.ok{color:var(--gold);}
.log-status.err{color:var(--red);}
.log-status.warn{color:var(--yellow);}
.log-detail{color:var(--dim);flex-shrink:0;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* ═══ VIEWS ═══ */
.view{display:none;}
.view.active{display:block;}

/* Cards */
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:16px;}
.card h3{color:var(--white);font-size:16px;margin-bottom:8px;}
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;}

/* Stat cards */
.stat{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;}
.stat .label{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;}
.stat .value{font-size:28px;font-weight:800;color:var(--white);font-family:var(--mono);}
.stat .value.gold{color:var(--gold);}

/* Identity card */
.identity-card{
    background:linear-gradient(135deg, #0A0A0A 0%, #111 100%);
    border:1px solid rgba(212,175,55,0.2);border-radius:16px;padding:28px;
    margin-bottom:16px;position:relative;overflow:hidden;
}
.identity-card::before{
    content:'';position:absolute;top:-50%;right:-50%;width:200%;height:200%;
    background:radial-gradient(circle at 70% 30%, rgba(212,175,55,0.04) 0%, transparent 50%);
    pointer-events:none;
}
.identity-inner{display:flex;gap:24px;align-items:center;flex-wrap:wrap;}
.identity-info{flex:1;min-width:200px;}
.identity-label{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:4px;}
.identity-code{
    font-family:var(--mono);font-size:28px;font-weight:800;color:var(--gold);
    letter-spacing:2px;margin-bottom:12px;
}
.identity-link{
    display:flex;align-items:center;gap:8px;
    background:var(--bg);border:1px solid var(--border);border-radius:8px;
    padding:10px 14px;margin-bottom:12px;max-width:400px;
}
.identity-link input{
    flex:1;background:none;border:none;color:var(--text);
    font-family:var(--mono);font-size:13px;outline:none;
}
.identity-link button{
    background:var(--gold);color:#000;border:none;
    padding:6px 14px;border-radius:6px;font-size:12px;font-weight:600;
    transition:all 0.2s;white-space:nowrap;
}
.identity-link button:hover{box-shadow:0 0 20px rgba(212,175,55,0.4);}
.identity-qr{
    width:120px;height:120px;background:white;border-radius:8px;
    display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.identity-qr img{width:110px;height:110px;border-radius:4px;}
.identity-tier{
    display:inline-block;padding:3px 10px;border-radius:99px;
    font-size:11px;font-weight:600;letter-spacing:0.5px;
    background:rgba(212,175,55,0.1);color:var(--gold);border:1px solid rgba(212,175,55,0.2);
}

/* Forms */
.form-row{display:flex;gap:12px;margin-bottom:12px;}
.form-row.stack{flex-direction:column;}
.form-group{flex:1;}
.form-group label{display:block;font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
.form-group input,.form-group select,.form-group textarea{
    width:100%;background:var(--bg);border:1px solid var(--border);
    color:var(--white);padding:10px 12px;border-radius:8px;font-size:13px;
    transition:border-color 0.2s;
}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--gold);outline:none;}
.form-group input::placeholder,.form-group textarea::placeholder{color:var(--dim);}
.form-group textarea{resize:vertical;min-height:60px;font-family:var(--font);line-height:1.5;}
.btn{
    display:inline-flex;align-items:center;gap:6px;
    padding:10px 20px;border-radius:8px;font-size:13px;font-weight:600;
    border:none;transition:all 0.2s;
}
.btn-gold{background:var(--gold);color:#000;font-weight:600;}
.btn-gold:hover{box-shadow:0 0 30px rgba(212,175,55,0.5);transform:scale(1.02);}
.btn-ghost{background:none;border:1px solid var(--border);color:var(--text);}
.btn-ghost:hover{border-color:var(--gold);color:var(--gold);}
.btn-sm{padding:5px 12px;font-size:12px;border-radius:6px;}
.btn-orange{background:var(--orange);color:var(--bg);}
.btn-orange:hover{background:var(--yellow);}
.btn-red{background:none;border:1px solid rgba(239,71,111,0.3);color:var(--red);}
.btn-red:hover{background:rgba(239,71,111,0.1);border-color:var(--red);}

/* Search bar */
.search-bar{
    display:flex;align-items:center;gap:8px;
    background:var(--surface);border:1px solid var(--border);border-radius:10px;
    padding:8px 14px;margin-bottom:16px;
}
.search-bar svg{width:16px;height:16px;color:var(--dim);flex-shrink:0;}
.search-bar input{
    flex:1;background:none;border:none;color:var(--white);
    font-size:13px;outline:none;
}
.search-bar input::placeholder{color:var(--dim);}

/* Tables */
table{width:100%;border-collapse:collapse;}
th{text-align:left;font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;padding:10px 12px;border-bottom:1px solid var(--border);}
td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:top;}
td.mono{font-family:var(--mono);}
td.gold{color:var(--gold);font-weight:600;}
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;}
.badge.green{background:rgba(212,175,55,0.1);color:var(--gold);}
.badge.yellow{background:rgba(255,209,102,0.1);color:var(--yellow);}
.badge.red{background:rgba(239,71,111,0.1);color:var(--red);}

/* Contact row inline editing */
.contact-row td{transition:background 0.15s;}
.contact-row:hover td{background:rgba(255,255,255,0.02);}
.contact-row.editing td{background:rgba(212,175,55,0.03);}
.contact-row .cell-display{display:block;}
.contact-row .cell-edit{display:none;}
.contact-row.editing .cell-display{display:none;}
.contact-row.editing .cell-edit{display:block;}
.cell-edit input,.cell-edit textarea{
    width:100%;background:var(--bg);border:1px solid var(--border-l);
    color:var(--white);padding:6px 8px;border-radius:6px;font-size:13px;
}
.cell-edit input:focus,.cell-edit textarea:focus{border-color:var(--gold);outline:none;}
.cell-edit textarea{min-height:40px;resize:vertical;font-family:var(--font);font-size:12px;line-height:1.4;}
.contact-actions{display:flex;gap:4px;flex-wrap:nowrap;}

/* Contact notes (expandable) */
.contact-notes{
    font-size:12px;color:var(--dim);margin-top:4px;
    max-height:40px;overflow:hidden;transition:max-height 0.2s;
    cursor:pointer;
}
.contact-notes.expanded{max-height:200px;}
.contact-notes:empty{display:none;}

/* Test runner */
.test-scenario{
    background:var(--surface);border:1px solid var(--border);border-radius:12px;
    padding:20px;margin-bottom:12px;transition:all 0.2s;
}
.test-scenario:hover{border-color:var(--border-l);}
.test-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.test-name{font-weight:600;color:var(--white);}
.test-status{font-family:var(--mono);font-size:12px;}
.test-steps{font-size:13px;color:var(--dim);margin-bottom:12px;line-height:1.7;}
.test-output{
    background:var(--bg);border:1px solid var(--border);border-radius:8px;
    padding:12px;font-family:var(--mono);font-size:12px;
    max-height:200px;overflow-y:auto;display:none;margin-top:12px;
}
.test-output.show{display:block;}

/* Security panel */
.sec-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;}
.sec-item{
    background:var(--surface);border:1px solid var(--border);border-radius:12px;
    padding:20px;display:flex;gap:16px;align-items:flex-start;
}
.sec-icon{
    width:40px;height:40px;min-width:40px;border-radius:10px;
    display:flex;align-items:center;justify-content:center;font-size:18px;
}
.sec-icon.ok{background:rgba(212,175,55,0.1);color:var(--gold);}
.sec-icon.warn{background:rgba(255,209,102,0.1);color:var(--yellow);}
.sec-icon.info{background:rgba(0,212,255,0.1);color:#0ad;}
.sec-item h4{color:var(--white);font-size:14px;margin-bottom:4px;}
.sec-item p{font-size:12px;color:var(--dim);line-height:1.5;}

/* Activity feed */
.activity-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);}
.activity-dot{width:8px;height:8px;border-radius:50%;margin-top:6px;flex-shrink:0;}
.activity-text{flex:1;font-size:13px;}
.activity-time{color:var(--dim);font-size:12px;font-family:var(--mono);flex-shrink:0;}

/* Toast notification */
.toast{
    position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);
    background:var(--surface2);border:1px solid var(--gold);
    color:var(--white);padding:10px 20px;border-radius:10px;
    font-size:13px;opacity:0;transition:all 0.3s;pointer-events:none;z-index:200;
    box-shadow:0 8px 32px rgba(0,0,0,0.5);
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ═══ FOOTER ═══ */
footer{
    border-top:1px solid var(--border);padding:16px 20px;
    margin-top:auto;
}
.footer-inner{
    max-width:1200px;margin:0 auto;
    display:flex;justify-content:space-between;align-items:center;
    flex-wrap:wrap;gap:12px;font-size:12px;color:var(--dim);
}
.footer-links{display:flex;gap:16px;}
.footer-links a{color:var(--dim);font-size:12px;}
.footer-links a:hover{color:var(--text);}
.footer-status{display:flex;align-items:center;gap:6px;font-family:var(--mono);}
.footer-status .dot{width:6px;height:6px;border-radius:50%;background:var(--gold);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:0.4;}50%{opacity:1;}}

/* ═══ MOBILE ═══ */
@media(max-width:768px){
    .nav-center{display:none;}
    .form-row{flex-direction:column;}
    .card-grid{grid-template-columns:1fr 1fr;}
    .sec-grid{grid-template-columns:1fr;}
    .identity-inner{flex-direction:column;align-items:flex-start;}
    .identity-qr{align-self:center;}
    .header-main{padding:0 12px;}
    .content{padding:16px 12px;}
    .card{padding:16px;}
    /* Mobile contact cards instead of table */
    .contacts-table-wrap{overflow-x:auto;}
}
@media(max-width:480px){
    .card-grid{grid-template-columns:1fr;}
    .identity-code{font-size:22px;}
    .ssl-badge{display:none;}
}

/* Mobile nav drawer */
.mobile-nav{display:none;}
@media(max-width:768px){
    .mobile-nav{
        display:flex;gap:2px;padding:8px 12px;overflow-x:auto;
        border-bottom:1px solid var(--border);
        -webkit-overflow-scrolling:touch;
        scrollbar-width:none;
    }
    .mobile-nav::-webkit-scrollbar{display:none;}
    .mobile-nav .nav-btn{white-space:nowrap;font-size:12px;padding:6px 12px;}
}
</style>
</head>
<body>

<!-- ═══ HEADER ═══ -->
<header>
    <div class="header-main">
        <div class="logo" onclick="navigate('home')">
            <svg viewBox="0 0 512 512" fill="none"><rect width="512" height="512" rx="96" fill="#000"/><circle cx="256" cy="256" r="140" stroke="url(#g1)" stroke-width="36" opacity=".95"/><circle cx="360" cy="152" r="16" fill="#D4AF37" opacity=".9"/><circle cx="360" cy="152" r="8" fill="#fff" opacity=".7"/><defs><linearGradient id="g1" x1="116" y1="116" x2="396" y2="396"><stop stop-color="#D4AF37"/><stop offset="1" stop-color="#B8962E"/></linearGradient></defs></svg>
            fortune0
        </div>
        <div class="nav-center">
            <button class="nav-btn active" data-view="home" onclick="navigate('home')">Dashboard</button>
            <button class="nav-btn" data-view="contacts" onclick="navigate('contacts')">Contacts</button>
            <button class="nav-btn" data-view="affiliates" onclick="navigate('affiliates')">Affiliates</button>
            <button class="nav-btn" data-view="security" onclick="navigate('security')">Security</button>
            <button class="nav-btn" data-view="tests" onclick="navigate('tests')">Tests</button>
        </div>
        <div class="nav-right">
            <div class="ssl-badge">
                <svg viewBox="0 0 16 16" fill="none"><path d="M12 7H4a1 1 0 00-1 1v5a1 1 0 001 1h8a1 1 0 001-1V8a1 1 0 00-1-1z" stroke="currentColor" stroke-width="1.5"/><path d="M5 7V5a3 3 0 016 0v2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                <span id="ssl-text">HTTPS</span>
            </div>
            <div class="auth-state">
                <div class="auth-dot" id="auth-dot"></div>
                <span id="auth-label">Not signed in</span>
            </div>
        </div>
    </div>
    <!-- Mobile nav -->
    <div class="mobile-nav">
        <button class="nav-btn active" data-view="home" onclick="navigate('home')">Dashboard</button>
        <button class="nav-btn" data-view="contacts" onclick="navigate('contacts')">Contacts</button>
        <button class="nav-btn" data-view="affiliates" onclick="navigate('affiliates')">Affiliates</button>
        <button class="nav-btn" data-view="security" onclick="navigate('security')">Security</button>
        <button class="nav-btn" data-view="tests" onclick="navigate('tests')">Tests</button>
    </div>
    <div class="breadcrumb" id="breadcrumb">
        <a href="#" onclick="navigate('home')">fortune0</a>
        <span class="sep">/</span>
        <span id="breadcrumb-page">dashboard</span>
    </div>
</header>

<!-- ═══ MAIN CONTENT ═══ -->
<div class="main">
<div class="content">

<!-- HOME / DASHBOARD -->
<div class="view active" id="view-home">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <div>
            <h2 style="color:var(--white);font-size:22px;" id="welcome-msg">Welcome to fortune0</h2>
            <p style="color:var(--dim);font-size:13px;" id="welcome-sub">Sign in to see your dashboard</p>
        </div>
        <div id="auth-actions"></div>
    </div>

    <!-- Quick login -->
    <div class="card" id="login-card">
        <h3>Quick sign in</h3>
        <p style="margin-bottom:16px;font-size:13px;">Enter an email to create a free account or sign in. No password needed.</p>
        <div class="form-row">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="login-email" placeholder="you@example.com" onkeydown="if(event.key==='Enter')doLogin()">
            </div>
        </div>
        <button class="btn btn-gold" onclick="doLogin()">Sign in / Create account</button>
    </div>

    <!-- Dashboard content (shown when logged in) -->
    <div id="dashboard-stats" style="display:none;">

        <!-- Identity card — your referral code is your identity -->
        <div class="identity-card">
            <div class="identity-inner">
                <div class="identity-info">
                    <div class="identity-label">Your referral code</div>
                    <div class="identity-code" id="referral-code">—</div>
                    <div class="identity-link">
                        <input type="text" id="referral-link" readonly value="">
                        <button onclick="copyReferralLink()">Copy</button>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                        <span class="identity-tier" id="user-tier">FREE</span>
                        <span style="font-size:12px;color:var(--dim);">Share your code. Earn commission on every sale.</span>
                    </div>
                </div>
                <div class="identity-qr" id="qr-container">
                    <span style="font-size:11px;color:#999;">QR</span>
                </div>
            </div>
        </div>

        <!-- Stats grid -->
        <div class="card-grid" style="margin-bottom:16px;">
            <div class="stat"><div class="label">Contacts</div><div class="value gold" id="stat-contacts">0</div></div>
            <div class="stat"><div class="label">Affiliates</div><div class="value gold" id="stat-affiliates">0</div></div>
            <div class="stat"><div class="label">Commissions</div><div class="value" id="stat-commissions">0</div></div>
            <div class="stat"><div class="label">Revenue</div><div class="value gold" id="stat-revenue">$0</div></div>
        </div>

        <!-- Recent activity -->
        <div class="card">
            <h3>Recent activity</h3>
            <div id="activity-feed"><p style="color:var(--dim)">No activity yet. Try adding a contact or registering an affiliate.</p></div>
        </div>
    </div>
</div>

<!-- CONTACTS -->
<div class="view" id="view-contacts">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
        <h2 style="color:var(--white);font-size:22px;">Contacts</h2>
        <div style="display:flex;gap:8px;">
            <button class="btn btn-ghost btn-sm" id="toggle-add-btn" onclick="toggleAddContact()">+ Add</button>
        </div>
    </div>

    <!-- Search -->
    <div class="search-bar">
        <svg viewBox="0 0 16 16" fill="none"><circle cx="6.5" cy="6.5" r="5" stroke="currentColor" stroke-width="1.5"/><path d="M10 10l4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        <input type="text" id="contact-search" placeholder="Search contacts by name, email, or company..." oninput="searchContacts()">
    </div>

    <!-- Add contact form (initially hidden) -->
    <div class="card" id="add-contact-form" style="display:none;">
        <h3>New contact</h3>
        <div class="form-row">
            <div class="form-group"><label>Name</label><input id="c-name" placeholder="Jane Smith" onkeydown="if(event.key==='Enter')addContact()"></div>
            <div class="form-group"><label>Email</label><input id="c-email" placeholder="jane@example.com"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>Phone</label><input id="c-phone" placeholder="555-0123"></div>
            <div class="form-group"><label>Company</label><input id="c-company" placeholder="Acme Inc"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>Notes</label><textarea id="c-notes" placeholder="Any notes about this contact..."></textarea></div>
        </div>
        <div style="display:flex;gap:8px;">
            <button class="btn btn-gold" onclick="addContact()">Save contact</button>
            <button class="btn btn-ghost" onclick="toggleAddContact()">Cancel</button>
        </div>
    </div>

    <!-- Contacts table -->
    <div class="card" style="padding:0;overflow:hidden;">
        <div class="contacts-table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Company</th>
                        <th>Notes</th>
                        <th style="width:110px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="contacts-table">
                    <tr><td colspan="6" style="color:var(--dim);padding:20px 12px;">No contacts yet. Click "+ Add" to get started.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- AFFILIATES -->
<div class="view" id="view-affiliates">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2 style="color:var(--white);font-size:22px;">Affiliates &amp; Commissions</h2>
        <button class="btn btn-ghost btn-sm" onclick="document.getElementById('add-aff-form').style.display='block'">+ Register</button>
    </div>

    <div class="card" id="add-aff-form" style="display:none;">
        <h3>Register affiliate</h3>
        <div class="form-row">
            <div class="form-group"><label>Email</label><input id="a-email" placeholder="creator@example.com"></div>
            <div class="form-group"><label>Commission %</label><input type="number" id="a-rate" value="10" min="1" max="50"></div>
        </div>
        <div style="display:flex;gap:8px;">
            <button class="btn btn-gold" onclick="addAffiliate()">Register</button>
            <button class="btn btn-ghost" onclick="document.getElementById('add-aff-form').style.display='none'">Cancel</button>
        </div>
    </div>

    <div class="card">
        <h3>Affiliates</h3>
        <table>
            <thead><tr><th>Email</th><th>Code</th><th>Rate</th><th>Referrals</th><th>Earned</th></tr></thead>
            <tbody id="aff-table"><tr><td colspan="5" style="color:var(--dim)">No affiliates registered</td></tr></tbody>
        </table>
    </div>

    <div class="card">
        <h3 style="margin-bottom:12px;">Simulate order (webhook test)</h3>
        <div class="form-row">
            <div class="form-group"><label>Discount code</label><input id="o-code" placeholder="IK-XXXXXXXX"></div>
            <div class="form-group"><label>Order total ($)</label><input type="number" id="o-total" value="150" step="0.01"></div>
        </div>
        <button class="btn btn-orange" onclick="simulateOrder()">Fire webhook</button>
    </div>

    <div class="card">
        <h3>Commission history</h3>
        <table>
            <thead><tr><th>Order</th><th>Affiliate</th><th>Code</th><th>Total</th><th>Commission</th><th>Platform fee</th><th>Status</th></tr></thead>
            <tbody id="comm-table"><tr><td colspan="7" style="color:var(--dim)">No commissions yet</td></tr></tbody>
        </table>
    </div>
</div>

<!-- SECURITY -->
<div class="view" id="view-security">
    <h2 style="color:var(--white);font-size:22px;margin-bottom:20px;">Security &amp; transparency</h2>
    <p style="margin-bottom:24px;color:var(--dim);">Every security layer, visible. This is what "enterprise grade" actually means — not hidden complexity, but transparent protection.</p>
    <div class="sec-grid" id="security-grid"></div>
    <div class="card" style="margin-top:20px;">
        <h3>Token inspector</h3>
        <p style="color:var(--dim);font-size:13px;margin-bottom:12px;">Your current session state. In production, tokens are HTTP-only cookies.</p>
        <div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px;font-family:var(--mono);font-size:12px;word-break:break-all;white-space:pre-wrap;" id="token-display">
            Not authenticated. Sign in to see your token.
        </div>
    </div>
</div>

<!-- TEST RUNNER -->
<div class="view" id="view-tests">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <div>
            <h2 style="color:var(--white);font-size:22px;">Test runner</h2>
            <p style="color:var(--dim);font-size:13px;">Scripted scenarios that exercise the full platform.</p>
        </div>
        <button class="btn btn-gold" onclick="runAllTests()">Run all</button>
    </div>
    <div id="test-list"></div>
</div>

</div>
</div>

<!-- ═══ FOOTER ═══ -->
<footer>
    <div class="footer-inner">
        <div style="display:flex;align-items:center;gap:8px;">
            <span>fortune0 v1.0</span>
            <span style="color:var(--border);">|</span>
            <div class="footer-status"><div class="dot"></div> <span id="footer-api-status">System ready</span></div>
        </div>
        <div class="footer-links">
            <a href="/">Home</a>
            <a href="/ideas">Ideas</a>
            <a href="/join">Earn</a>
            <a href="/setup">Setup</a>
        </div>
    </div>
</footer>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- ═══ CONSOLE TOGGLE ═══ -->
<button class="console-toggle" onclick="toggleConsole()">
    <span>Console</span>
    <span class="count" id="log-count">0</span>
</button>

<!-- ═══ CONSOLE PANEL ═══ -->
<div class="console" id="console">
    <div class="console-header">
        <h4>
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M5 4l4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            System console
        </h4>
        <div class="console-actions">
            <button class="console-btn" onclick="exportLogs()">Export</button>
            <button class="console-btn danger" onclick="clearLogs()">Clear</button>
            <button class="console-btn" onclick="toggleConsole()">Close</button>
        </div>
    </div>
    <div class="console-body" id="console-body"></div>
</div>

<script>
// ═══════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════
const state = {
    user: null,
    token: null,
    logs: [],
    consoleOpen: false,
    contacts: [],      // cached for inline editing
    editingId: null,    // currently editing contact id
};

// ═══════════════════════════════════════════
// TOAST
// ═══════════════════════════════════════════
function toast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2500);
}

// ═══════════════════════════════════════════
// LOGGING
// ═══════════════════════════════════════════
function log(method, path, status, detail = '') {
    const entry = {
        time: new Date().toLocaleTimeString('en-US', {hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'}),
        method, path, status, detail
    };
    state.logs.push(entry);
    renderLog(entry);
    document.getElementById('log-count').textContent = state.logs.length;
}

function renderLog(e) {
    const body = document.getElementById('console-body');
    const statusClass = e.status >= 400 ? 'err' : e.status >= 300 ? 'warn' : 'ok';
    body.innerHTML += `<div class="log-entry"><span class="log-time">${e.time}</span><span class="log-method ${e.method}">${e.method}</span><span class="log-path">${e.path}</span><span class="log-status ${statusClass}">${e.status}</span><span class="log-detail">${e.detail}</span></div>`;
    body.scrollTop = body.scrollHeight;
}

function clearLogs() { state.logs = []; document.getElementById('console-body').innerHTML = ''; document.getElementById('log-count').textContent = '0'; }
function exportLogs() {
    const text = state.logs.map(l => `${l.time} ${l.method} ${l.path} ${l.status} ${l.detail}`).join('\n');
    const blob = new Blob([text], {type:'text/plain'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'fortune0-logs.txt'; a.click();
    log('SYS', '/export-logs', 200, `Exported ${state.logs.length} entries`);
}
function toggleConsole() {
    state.consoleOpen = !state.consoleOpen;
    document.getElementById('console').classList.toggle('open', state.consoleOpen);
}

// ═══════════════════════════════════════════
// API HELPER
// ═══════════════════════════════════════════
async function api(method, path, body = null) {
    const opts = {
        method,
        headers: { 'Content-Type': 'application/json' },
    };
    if (state.token) opts.headers['Authorization'] = 'Bearer ' + state.token;
    if (body) opts.body = JSON.stringify(body);
    const t0 = performance.now();
    try {
        const resp = await fetch(path, opts);
        const ct = resp.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
            log('ERR', path, resp.status, 'No API server — got HTML instead of JSON');
            return { ok: false, status: resp.status, data: { error: 'API server not running. Run: python3 server.py' } };
        }
        const data = await resp.json();
        const ms = Math.round(performance.now() - t0);
        if (resp.ok) {
            log(method, path, resp.status, `${ms}ms`);
        } else {
            log('ERR', path, resp.status, data.error || JSON.stringify(data));
        }
        return { ok: resp.ok, status: resp.status, data };
    } catch (err) {
        log('ERR', path, 0, err.message);
        return { ok: false, status: 0, data: { error: err.message } };
    }
}

// ═══════════════════════════════════════════
// AUTH
// ═══════════════════════════════════════════
async function doLogin() {
    const btn = document.querySelector('#login-card .btn-gold');
    const email = document.getElementById('login-email').value.trim().toLowerCase();
    if (!email) { toast('Enter an email address'); return; }

    btn.textContent = 'Connecting...';
    btn.disabled = true;
    log('SEC', '/crypto/hmac', 200, 'Generating HMAC-signed license key...');

    try {
        const { ok, data } = await api('POST', '/api/signup', { email });
        if (!ok) {
            btn.textContent = 'Sign in / Create account';
            btn.disabled = false;
            toast('Error: ' + (data.error || 'Could not connect'));
            return;
        }

        state.token = data.token;
        state.user = { email: data.email, refCode: data.referral_code, tier: data.tier };

        log('SEC', '/auth/session', 200, `Token: ${data.token.slice(0, 12)}...`);
        if (data.new) {
            log('SYS', '/db/init', 200, `New account: ${email}`);
            toast('Account created!');
        } else {
            log('SYS', '/auth', 200, `Welcome back, ${email}`);
            toast('Signed in!');
        }

        updateAuthUI();
        await refreshData();
        navigate('home');
    } catch (err) {
        btn.textContent = 'Sign in / Create account';
        btn.disabled = false;
        toast('Connection failed: ' + err.message);
    }
}

function doLogout() {
    log('POST', '/api/logout', 200, `Session destroyed for ${state.user?.email}`);
    state.user = null;
    state.token = null;
    state.contacts = [];
    updateAuthUI();
    navigate('home');
    toast('Signed out');
}

function updateAuthUI() {
    const dot = document.getElementById('auth-dot');
    const label = document.getElementById('auth-label');
    const tokenDisplay = document.getElementById('token-display');

    if (state.user) {
        dot.className = 'auth-dot on';
        label.textContent = state.user.email;
        label.style.color = 'var(--gold)';
        document.getElementById('login-card').style.display = 'none';
        document.getElementById('dashboard-stats').style.display = 'block';
        document.getElementById('welcome-msg').textContent = `Welcome back`;
        document.getElementById('welcome-sub').textContent = state.user.email;
        document.getElementById('referral-code').textContent = state.user.refCode;
        document.getElementById('user-tier').textContent = state.user.tier.toUpperCase();
        document.getElementById('auth-actions').innerHTML = `<button class="btn btn-ghost btn-sm" onclick="doLogout()">Sign out</button>`;

        // Referral link
        const host = location.origin;
        const refLink = `${host}/r/${state.user.refCode}`;
        document.getElementById('referral-link').value = refLink;

        // QR code
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&color=D4AF37&bgcolor=FFFFFF&data=${encodeURIComponent(refLink)}`;
        document.getElementById('qr-container').innerHTML = `<img src="${qrUrl}" alt="QR Code" onerror="this.parentElement.innerHTML='<span style=\\'font-size:11px;color:#999\\'>QR</span>'">`;

        // Token inspector
        tokenDisplay.innerHTML =
            `<span style="color:var(--gold)">Session token:</span> ${state.token}\n` +
            `<span style="color:var(--gold)">User:</span> ${state.user.email}\n` +
            `<span style="color:var(--gold)">Tier:</span> ${state.user.tier}\n` +
            `<span style="color:var(--gold)">Referral:</span> ${state.user.refCode}\n` +
            `<span style="color:var(--gold)">Expires:</span> 7 days\n` +
            `<span style="color:var(--dim)">In production: HTTP-only secure cookie, not visible to JS</span>`;
    } else {
        dot.className = 'auth-dot off';
        label.textContent = 'Not signed in';
        label.style.color = 'var(--dim)';
        document.getElementById('login-card').style.display = 'block';
        document.getElementById('dashboard-stats').style.display = 'none';
        document.getElementById('welcome-msg').textContent = 'Welcome to fortune0';
        document.getElementById('welcome-sub').textContent = 'Sign in to see your dashboard';
        document.getElementById('auth-actions').innerHTML = '';
        tokenDisplay.textContent = 'Not authenticated. Sign in to see your token.';
    }
}

function copyReferralLink() {
    const input = document.getElementById('referral-link');
    input.select();
    navigator.clipboard.writeText(input.value).then(() => toast('Copied!')).catch(() => {
        document.execCommand('copy');
        toast('Copied!');
    });
}

// ═══════════════════════════════════════════
// DATA REFRESH
// ═══════════════════════════════════════════
async function refreshData() {
    if (!state.token) return;
    await Promise.all([refreshStats(), refreshContacts(), refreshAffiliates(), refreshCommissions()]);
}

async function refreshStats() {
    const { ok, data } = await api('GET', '/api/stats');
    if (!ok) return;
    document.getElementById('stat-contacts').textContent = data.contacts;
    document.getElementById('stat-affiliates').textContent = data.affiliates;
    document.getElementById('stat-commissions').textContent = data.commissions;
    document.getElementById('stat-revenue').textContent = `$${Number(data.attributed_revenue).toLocaleString()}`;

    // Activity feed
    const feed = document.getElementById('activity-feed');
    if (data.activity && data.activity.length > 0) {
        feed.innerHTML = data.activity.map(a =>
            `<div class="activity-item">
                <div class="activity-dot" style="background:var(--gold)"></div>
                <div class="activity-text"><span style="color:var(--white)">${esc(a.action)}</span> ${esc(a.detail || '')}</div>
                <div class="activity-time">${a.created_at || ''}</div>
            </div>`
        ).join('');
    } else {
        feed.innerHTML = '<p style="color:var(--dim)">No activity yet.</p>';
    }
}

async function refreshContacts() {
    const q = document.getElementById('contact-search')?.value || '';
    const path = q ? `/api/contacts?q=${encodeURIComponent(q)}` : '/api/contacts';
    const { ok, data } = await api('GET', path);
    if (!ok) return;
    state.contacts = data;
    renderContacts();
}

function renderContacts() {
    const tbody = document.getElementById('contacts-table');
    const data = state.contacts;
    if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="color:var(--dim);padding:20px 12px;">No contacts yet. Click "+ Add" to get started.</td></tr>';
        return;
    }
    tbody.innerHTML = data.map(c => {
        const isEditing = state.editingId === c.id;
        return `<tr class="contact-row ${isEditing ? 'editing' : ''}" data-id="${c.id}">
            <td>
                <span class="cell-display" style="color:var(--white);font-weight:500;">${esc(c.name)}</span>
                <input class="cell-edit" data-field="name" value="${attr(c.name)}">
            </td>
            <td>
                <span class="cell-display" style="font-family:var(--mono);font-size:12px;">${esc(c.email) || '<span style="color:var(--dim)">—</span>'}</span>
                <input class="cell-edit" data-field="email" value="${attr(c.email || '')}">
            </td>
            <td>
                <span class="cell-display" style="font-family:var(--mono);font-size:12px;">${esc(c.phone) || '<span style="color:var(--dim)">—</span>'}</span>
                <input class="cell-edit" data-field="phone" value="${attr(c.phone || '')}">
            </td>
            <td>
                <span class="cell-display">${esc(c.company) || '<span style="color:var(--dim)">—</span>'}</span>
                <input class="cell-edit" data-field="company" value="${attr(c.company || '')}">
            </td>
            <td>
                <span class="cell-display contact-notes" onclick="this.classList.toggle('expanded')">${esc(c.notes) || '<span style="color:var(--dim)">—</span>'}</span>
                <textarea class="cell-edit" data-field="notes">${esc(c.notes || '')}</textarea>
            </td>
            <td>
                <div class="contact-actions">
                    ${isEditing
                        ? `<button class="btn btn-gold btn-sm" onclick="saveContact(${c.id})">Save</button>
                           <button class="btn btn-ghost btn-sm" onclick="cancelEdit()">Cancel</button>`
                        : `<button class="btn btn-ghost btn-sm" onclick="startEdit(${c.id})">Edit</button>
                           <button class="btn btn-red btn-sm" onclick="deleteContact(${c.id})">Del</button>`
                    }
                </div>
            </td>
        </tr>`;
    }).join('');
}

function searchContacts() {
    clearTimeout(window._searchTimer);
    window._searchTimer = setTimeout(() => refreshContacts(), 300);
}

function toggleAddContact() {
    const form = document.getElementById('add-contact-form');
    const showing = form.style.display !== 'none';
    form.style.display = showing ? 'none' : 'block';
    if (!showing) document.getElementById('c-name').focus();
}

// ═══════════════════════════════════════════
// INLINE EDITING — no more prompt() dialogs
// ═══════════════════════════════════════════
function startEdit(id) {
    state.editingId = id;
    renderContacts();
    // Focus the name field
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if (row) {
        const nameInput = row.querySelector('input[data-field="name"]');
        if (nameInput) nameInput.focus();
    }
}

function cancelEdit() {
    state.editingId = null;
    renderContacts();
}

async function saveContact(id) {
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if (!row) return;

    const fields = {};
    row.querySelectorAll('.cell-edit').forEach(el => {
        fields[el.dataset.field] = el.value;
    });

    if (!fields.name || !fields.name.trim()) {
        toast('Name is required');
        return;
    }

    const { ok } = await api('POST', '/api/contacts/update', { id, ...fields });
    if (ok) {
        state.editingId = null;
        toast('Contact updated');
        await refreshContacts();
        await refreshStats();
    } else {
        toast('Failed to update contact');
    }
}

async function deleteContact(id) {
    const c = state.contacts.find(x => x.id === id);
    const name = c ? c.name : 'this contact';
    if (!confirm(`Delete ${name}?`)) return;
    const { ok } = await api('POST', '/api/contacts/delete', { id });
    if (ok) {
        toast('Contact deleted');
        await refreshContacts();
        await refreshStats();
    }
}

// ═══════════════════════════════════════════
// AFFILIATES
// ═══════════════════════════════════════════
async function refreshAffiliates() {
    const { ok, data } = await api('GET', '/api/affiliates');
    if (!ok) return;
    const tbody = document.getElementById('aff-table');
    if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="5" style="color:var(--dim)">No affiliates registered</td></tr>';
        return;
    }
    tbody.innerHTML = data.map(a =>
        `<tr><td style="color:var(--white)">${esc(a.email)}</td><td class="mono" style="color:var(--gold)">${esc(a.referral_code)}</td><td>${(a.commission_rate*100).toFixed(0)}%</td><td>${a.total_referrals}</td><td class="gold">$${Number(a.total_earned).toFixed(2)}</td></tr>`
    ).join('');
}

async function refreshCommissions() {
    const { ok, data } = await api('GET', '/api/commissions');
    if (!ok) return;
    const tbody = document.getElementById('comm-table');
    if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="7" style="color:var(--dim)">No commissions yet</td></tr>';
        return;
    }
    tbody.innerHTML = data.map(c =>
        `<tr><td class="mono">${esc(c.order_id)}</td><td>${esc(c.affiliate_email)}</td><td class="mono" style="color:var(--gold)">${esc(c.discount_code)}</td><td class="gold">$${Number(c.order_total).toFixed(2)}</td><td class="gold">$${Number(c.commission_amount).toFixed(2)}</td><td style="color:var(--dim)">$${Number(c.platform_fee).toFixed(2)} (${(c.platform_fee_rate*100)}%)</td><td><span class="badge yellow">${c.status}</span></td></tr>`
    ).join('');
}

// ═══════════════════════════════════════════
// CRUD
// ═══════════════════════════════════════════
async function addContact() {
    if (!state.token) { toast('Sign in first'); return; }
    const name = document.getElementById('c-name').value.trim();
    const email = document.getElementById('c-email').value.trim();
    const phone = document.getElementById('c-phone').value.trim();
    const company = document.getElementById('c-company').value.trim();
    const notes = document.getElementById('c-notes').value.trim();
    if (!name) { toast('Name is required'); return; }

    const { ok } = await api('POST', '/api/contacts', { name, email, phone, company, notes });
    if (!ok) return;

    document.getElementById('add-contact-form').style.display = 'none';
    ['c-name','c-email','c-phone','c-company','c-notes'].forEach(id => {
        const el = document.getElementById(id);
        if (el.tagName === 'TEXTAREA') el.value = '';
        else el.value = '';
    });
    toast(`Added ${name}`);
    await refreshContacts();
    await refreshStats();
}

async function addAffiliate() {
    if (!state.token) { toast('Sign in first'); return; }
    const email = document.getElementById('a-email').value.trim();
    const rate = parseFloat(document.getElementById('a-rate').value) / 100;
    if (!email) { toast('Email required'); return; }

    const { ok, data } = await api('POST', '/api/affiliates', { email, commission_rate: rate });
    if (!ok) return;

    log('SEC', '/crypto/referral', 200, `Code generated: ${data.referral_code}`);
    document.getElementById('add-aff-form').style.display = 'none';
    document.getElementById('a-email').value = '';
    toast(`Registered affiliate: ${data.referral_code}`);
    await refreshAffiliates();
    await refreshStats();
}

async function simulateOrder() {
    const code = document.getElementById('o-code').value.trim();
    const total = parseFloat(document.getElementById('o-total').value);
    if (!code) { toast('Discount code required'); return; }

    const { ok, data } = await api('POST', '/api/webhooks/order', {
        discount_code: code, order_total: total,
    });

    if (!ok) return;

    log('SYS', '/attribution', 200, `Attributed to ${data.affiliate}`);
    toast(`Commission: $${data.commission} to ${data.affiliate}`);

    await refreshAffiliates();
    await refreshCommissions();
    await refreshStats();
}

// ═══════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════
function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function attr(s) { if (!s) return ''; return s.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

// ═══════════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════════
const viewNames = { home:'Dashboard', contacts:'Contacts', affiliates:'Affiliates', security:'Security', tests:'Tests' };

function navigate(view) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    // Update both desktop and mobile nav
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('view-' + view).classList.add('active');
    document.querySelectorAll(`[data-view="${view}"]`).forEach(b => b.classList.add('active'));
    document.getElementById('breadcrumb-page').textContent = viewNames[view] || view;
    log('GET', '/' + (view === 'home' ? 'dashboard' : view), 200, `→ ${viewNames[view]}`);
    window.scrollTo(0, 0);

    if (state.token) {
        if (view === 'home') refreshStats();
        else if (view === 'contacts') refreshContacts();
        else if (view === 'affiliates') { refreshAffiliates(); refreshCommissions(); }
        else if (view === 'security') renderSecurity();
    }
}

// ═══════════════════════════════════════════
// SECURITY PANEL
// ═══════════════════════════════════════════
function renderSecurity() {
    const checks = [
        { icon: '🔒', cls: 'ok', title: 'HTTPS / TLS', desc: 'All traffic encrypted in transit. TLS certificates auto-provisioned.' },
        { icon: '🔑', cls: 'ok', title: 'HMAC-signed license keys', desc: 'SHA-256 signed, bound to email + expiry. Cannot be forged.' },
        { icon: '🗄️', cls: 'ok', title: 'Database isolation', desc: 'Per-user data isolation. No cross-user leakage possible.' },
        { icon: '🛡️', cls: 'ok', title: 'SQL injection protection', desc: 'All queries use parameterized statements. No string concat in SQL.' },
        { icon: '⏱️', cls: 'ok', title: 'Rate limiting', desc: '100 req/min per IP. Prevents brute force and abuse.' },
        { icon: '🪝', cls: 'ok', title: 'Webhook HMAC verification', desc: 'Webhooks are cryptographically verified before processing.' },
        { icon: '🍪', cls: 'info', title: 'Session tokens', desc: 'HTTP-only cookies with 7-day expiry. Visible in demo mode for transparency.' },
        { icon: '📋', cls: 'info', title: 'CORS policy', desc: 'Cross-Origin Resource Sharing enabled. Restrictable per domain in production.' },
        { icon: '🔐', cls: state.user ? 'ok' : 'warn', title: 'Authentication state', desc: state.user ? `Authenticated as ${state.user.email}. Token expires in 7 days.` : 'Not authenticated. Sign in to establish a session.' },
        { icon: '📊', cls: 'info', title: 'Audit logging', desc: 'Every API call logged. Open the console to see it live.' },
    ];
    document.getElementById('security-grid').innerHTML = checks.map(c =>
        `<div class="sec-item"><div class="sec-icon ${c.cls}">${c.icon}</div><div><h4>${c.title}</h4><p>${c.desc}</p></div></div>`
    ).join('');
}

// ═══════════════════════════════════════════
// TEST RUNNER
// ═══════════════════════════════════════════
const tests = [
    {
        name: 'Full signup → CRM → affiliate → order flow',
        steps: '1. Create account  2. Add contacts  3. Register affiliate  4. Simulate order  5. Verify commission',
        run: async function(output) {
            output('→ Creating account: test-runner@fortune0.com');
            document.getElementById('login-email').value = 'test-runner@fortune0.com';
            await doLogin();
            if (!state.token) { output('✗ Login failed'); return false; }
            output(`✓ Signed in. Token: ${state.token.slice(0,16)}...`);
            output(`✓ Referral code: ${state.user.refCode}`);
            const names = ['Alice Johnson', 'Bob Smith', 'Charlie Brown'];
            for (const name of names) {
                const { ok } = await api('POST', '/api/contacts', {
                    name, email: name.toLowerCase().replace(' ','@')+'example.com',
                    phone: '555-'+Math.floor(Math.random()*9000+1000), company: 'Test Corp'
                });
                output(ok ? `✓ Added contact: ${name}` : `✗ Failed: ${name}`);
            }
            const affEmail = 'influencer@example.com';
            const { ok: affOk, data: affData } = await api('POST', '/api/affiliates', { email: affEmail, commission_rate: 0.12 });
            output(affOk ? `✓ Registered affiliate: ${affEmail} (code: ${affData.referral_code})` : '✗ Failed');
            const { ok: ordOk, data: ordData } = await api('POST', '/api/webhooks/order', {
                discount_code: affData.referral_code, order_total: 500,
            });
            if (ordOk) {
                output(`✓ Order $500 attributed to ${ordData.affiliate}`);
                output(`  Commission: $${ordData.commission}`);
                output(`  Platform fee: $${ordData.platform_fee}`);
            } else { output('✗ Order failed'); }
            await refreshData();
            const { data: stats } = await api('GET', '/api/stats');
            output(`\n✓ Final: ${stats.contacts} contacts, ${stats.affiliates} affiliates, $${stats.attributed_revenue} revenue`);
            return true;
        }
    },
    {
        name: 'Auth boundary test',
        steps: '1. Log out  2. Try unauthenticated request  3. Verify 401  4. Log back in  5. Verify access',
        run: async function(output) {
            doLogout();
            output('→ Logged out');
            const { ok, status } = await api('POST', '/api/contacts', { name: 'Should Fail' });
            output(!ok && status === 401 ? '✓ Correctly rejected — 401' : '✗ FAIL');
            document.getElementById('login-email').value = 'auth-test@fortune0.com';
            await doLogin();
            output(state.token ? `✓ Authenticated as ${state.user.email}` : '✗ Login failed');
            const { ok: getOk } = await api('GET', '/api/contacts');
            output(getOk ? '✓ Access restored' : '✗ FAIL');
            return true;
        }
    },
    {
        name: 'Attribution edge cases',
        steps: '1. Register affiliate  2. Invalid code order  3. Valid code order  4. Verify counts',
        run: async function(output) {
            if (!state.token) { document.getElementById('login-email').value = 'edge-test@fortune0.com'; await doLogin(); }
            const affEmail = 'edge-aff-' + Date.now() + '@example.com';
            const { ok: regOk, data: regData } = await api('POST', '/api/affiliates', { email: affEmail, commission_rate: 0.15 });
            output(regOk ? `✓ Registered: ${regData.referral_code}` : '✗ Failed');
            const { data: before } = await api('GET', '/api/commissions');
            const countBefore = before.length;
            const { ok: badOk } = await api('POST', '/api/webhooks/order', { discount_code: 'FAKE-CODE-999', order_total: 100 });
            output(!badOk ? '✓ Invalid code rejected' : '✗ FAIL');
            const { ok: goodOk, data: goodData } = await api('POST', '/api/webhooks/order', {
                discount_code: regData.referral_code, order_total: 200,
            });
            output(goodOk ? `✓ Valid code attributed ($${goodData.commission})` : '✗ FAIL');
            const { data: after } = await api('GET', '/api/commissions');
            output(after.length === countBefore + 1 ? '✓ Exactly one new commission' : `⚠ Expected ${countBefore+1}, got ${after.length}`);
            await refreshData();
            return true;
        }
    },
    {
        name: 'Commission tier calculation',
        steps: '1. Register affiliate  2. Simulate $300K in orders  3. Verify tier changes',
        run: async function(output) {
            if (!state.token) { document.getElementById('login-email').value = 'tier-test@fortune0.com'; await doLogin(); }
            const affEmail = 'whale-' + Date.now() + '@example.com';
            const { ok: regOk, data: regData } = await api('POST', '/api/affiliates', { email: affEmail, commission_rate: 0.10 });
            output(regOk ? `✓ Registered: ${regData.referral_code}` : '✗ Failed');
            const amounts = [5000, 10000, 50000, 100000, 150000];
            for (const amt of amounts) {
                const { ok, data } = await api('POST', '/api/webhooks/order', {
                    discount_code: regData.referral_code, order_total: amt,
                });
                if (ok) {
                    const feePercent = (data.platform_fee / amt * 100).toFixed(1);
                    output(`  $${amt.toLocaleString()} → fee: $${data.platform_fee} (${feePercent}%)`);
                } else { output(`  ✗ $${amt.toLocaleString()} failed`); }
            }
            const { data: affs } = await api('GET', '/api/affiliates');
            const whale = affs.find(a => a.email === affEmail);
            if (whale) {
                output(`\n✓ Total earned: $${Number(whale.total_earned).toLocaleString()}`);
                output(`✓ Referrals: ${whale.total_referrals}`);
            }
            await refreshData();
            return true;
        }
    }
];

function renderTests() {
    document.getElementById('test-list').innerHTML = tests.map((t, i) =>
        `<div class="test-scenario" id="test-${i}">
            <div class="test-header">
                <span class="test-name">${t.name}</span>
                <button class="btn btn-ghost btn-sm" onclick="runTest(${i})">Run</button>
            </div>
            <div class="test-steps">${t.steps}</div>
            <div class="test-output" id="test-output-${i}"></div>
        </div>`
    ).join('');
}

async function runTest(i) {
    const output = document.getElementById('test-output-' + i);
    output.textContent = '';
    output.classList.add('show');
    log('TEST', `/tests/${i}`, 200, `Running: ${tests[i].name}`);
    try {
        await tests[i].run(line => { output.textContent += line + '\n'; });
        log('TEST', `/tests/${i}`, 200, 'PASSED');
        output.textContent += '\n✅ PASSED';
    } catch (e) {
        log('TEST', `/tests/${i}`, 500, `FAILED: ${e.message}`);
        output.textContent += `\n❌ FAILED: ${e.message}`;
    }
}

async function runAllTests() {
    for (let i = 0; i < tests.length; i++) {
        await runTest(i);
        await new Promise(r => setTimeout(r, 300));
    }
}

// ═══════════════════════════════════════════
// HEALTH CHECK
// ═══════════════════════════════════════════
async function checkHealth() {
    try {
        const resp = await fetch('/health');
        const ct = resp.headers.get('content-type') || '';
        if (!ct.includes('application/json')) throw new Error('No API server');
        const data = await resp.json();
        if (data.status === 'ok') {
            log('SYS', '/health', 200, `${data.service} v${data.version} — ${data.db}`);
            document.getElementById('footer-api-status').textContent = 'API connected';
            document.getElementById('footer-api-status').parentElement.querySelector('.dot').style.background = 'var(--gold)';
        }
    } catch (e) {
        log('ERR', '/health', 0, 'No API server — run: python3 server.py');
        document.getElementById('footer-api-status').textContent = 'API offline';
        document.getElementById('footer-api-status').parentElement.querySelector('.dot').style.background = 'var(--red)';
        const banner = document.createElement('div');
        banner.style.cssText = 'background:#1a1000;border-bottom:1px solid #D4AF37;padding:12px 20px;text-align:center;font-size:13px;color:#D4AF37;';
        banner.innerHTML = 'Dashboard requires the API server. Run: <code style="background:#000;padding:2px 8px;border-radius:4px;font-family:monospace;">python3 server.py</code> then open <a href="http://localhost:8080/app" style="color:#fff;">localhost:8080/app</a>';
        document.body.insertBefore(banner, document.body.firstChild);
    }
}

// ═══════════════════════════════════════════
// KEYBOARD SHORTCUTS
// ═══════════════════════════════════════════
document.addEventListener('keydown', e => {
    // Escape cancels editing
    if (e.key === 'Escape' && state.editingId) {
        cancelEdit();
    }
    // Enter saves when editing (unless in textarea)
    if (e.key === 'Enter' && state.editingId && e.target.tagName !== 'TEXTAREA') {
        e.preventDefault();
        saveContact(state.editingId);
    }
});

// ═══════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════
log('SYS', '/boot', 200, 'fortune0 platform v1.0');
log('SEC', '/tls', 200, 'HTTPS: ' + (location.protocol === 'https:' ? 'Active' : 'Inactive (dev)'));
log('SYS', '/db', 200, 'Connecting...');

document.getElementById('ssl-text').textContent = location.protocol === 'https:' ? 'HTTPS' : 'HTTP';
renderSecurity();
renderTests();
updateAuthUI();
checkHealth();
</script>
</body>
</html>
